CREATE OR REPLACE PROCEDURE DISHA_MART_ANALYTICS.REGULATORY_MART.LOAD_OUTSTANDING_MART("START_DATE" DATE DEFAULT DATE_ADDMONTHSTODATE(-1, CURRENT_DATE()))
RETURNS VARCHAR
LANGUAGE SQL
EXECUTE AS OWNER
AS 'DECLARE
    -- Logging Variables
	PROC_NAME VARCHAR(500):=''DISHA_MART_ANALYTICS.REGULATORY_MART.LOAD_OUTSTANDING_MART'';
	TBL_NAME VARCHAR(500):=''DISHA_MART_ANALYTICS.REGULATORY_MART.OUTSTANDING_MART'';
    TOTAL_ROWS_IN_PREFINAL INTEGER DEFAULT 0;
	DUELIST_CNT INTEGER DEFAULT 0;
	BOOKING_RPT_CNT INTEGER DEFAULT 0;
	RURAL_URBAN_CNT INTEGER DEFAULT 0;
	IND_ADF_CNT INTEGER DEFAULT 0;
	LOANS_LTV_COUNT INTEGER DEFAULT 0;
	BOLTON_CNT INTEGER DEFAULT 0;
	CORP_ADF_CNT INTEGER DEFAULT 0;
    ROWS_INSERTED INTEGER DEFAULT 0;
    ROWS_UPDATED INTEGER DEFAULT 0;
    ROWS_UNCHANGED INTEGER DEFAULT 0;
    DUPLICATE_COUNT INTEGER;
    DUPLICATE_DETAILS VARCHAR(2000);
    CURR_TIME TIMESTAMP := TO_VARCHAR(CURRENT_TIMESTAMP());
    ERROR_MESSAGE VARCHAR;
    FINAL_OUTPUT VARCHAR(4000);

BEGIN

	 
    -- Step 1: Initialize date parameters using LET statements
	
	LET FISCAL_START_DATE DATE := CASE 
        WHEN MONTH(START_DATE) >= 4 
        THEN TO_DATE(TO_CHAR(START_DATE, ''YYYY'') || ''-04-01'')
        ELSE TO_DATE(TO_CHAR(DATEADD(YEAR, -1, START_DATE), ''YYYY'') || ''-04-01'')
    END;
	
    LET MONTH_START_DATE DATE := DATE_TRUNC(''MONTH'', START_DATE);
    LET MONTH_END_DATE DATE := LAST_DAY(START_DATE);
	LET NEXT_MONTH_START_DATE DATE := DATEADD(DAY,1,MONTH_END_DATE);
	
	-- STEP : CLEAN UP TEMPORARY TABLES
	DROP TABLE IF EXISTS DISHA_MART_ANALYTICS.REGULATORY_MART.TEMP_ACTIVE_LOANS;
	DROP TABLE IF EXISTS DISHA_MART_ANALYTICS.REGULATORY_MART.OUTSTANDING_MART_PREFINAL;	

    CREATE TABLE IF NOT EXISTS DISHA_MART_ANALYTICS.REGULATORY_MART.OUTSTANDING_MART CLUSTER BY (DAILY_DATE)
	(
	DAILY_DATE DATE,
	REPORT_DATE DATE,
	LOAN_NUMBER_NEW VARCHAR(255),
	LOAN_NUMBER_OLD VARCHAR(255),
	--IGAAP_POS FLOAT,
	IND_AS_EAD FLOAT,
	ON_BOOK_POS FLOAT,
	TOTAL_POS_AS_PER_LMS FLOAT,
	ECL FLOAT,
	PRODUCT VARCHAR(255),
	SCHEME VARCHAR(255),
	NHB_PRODUCT VARCHAR(255),
	FIRST_DISBURSEMENT_DATE DATE,
	CUSTOMER_TYPE VARCHAR(255),
	ASSET_CLASSIFICATION_IGAAP VARCHAR(255),
	ASSET_CLASSIFICATION_IND_AS VARCHAR(255),
	RURAL_URBAN VARCHAR,
	PROPERTY_STATE VARCHAR(255),
	BRANCH_STATE VARCHAR(255),
	MONTHLY_INCOME_OF_BORROWERS_IN_LOAN FLOAT,
	CASTE_CATEGORY VARCHAR(50),
	TAGGING_OF_NHB_REFINANCE_CASES VARCHAR(50),
	HL_BIFURCATION_OF__EAD FLOAT,
	NHL_BIFURCATION_OF__EAD FLOAT,
	SHRIRAM_PROPERTY_INSURANCE_SC_CODE_160 FLOAT,
	INSURANCE_PREMIUM_HDFC_LIFE_SC_CODE_254 FLOAT,
	CERSAI_REGISTRATION_CHARGES_SC_CODE_1167 FLOAT,
	RCU_CHARGES_SC_CODE_1258 FLOAT,
	ICICI_LIFE_INSURANCE_SC_CODE_442 FLOAT,
	VALUATION_CHARGES_SC_CODE_1122 FLOAT,
	LEGAL_CHARGES_SC_CODE_1123 FLOAT,
	ICICI_LOMBARD_PROPERTY_INSURANCE_SC_CODE_439 FLOAT,
	BHARTI_AXA_LIFE_INSURANCE_SC_CODE_443 FLOAT,
	CARE_HEALTH_INSURANCE_SC_CODE_446 FLOAT,
	ADMINISTRATIVE_FEES_SC_CODE_1441 FLOAT,
	STAMPING_CHARGES_SC_CODE_1120 FLOAT,
	SERVICE_CHARGE_PDD_SC_CODE_1153 FLOAT,
	PROCESSING_FEES_SC_CODE_1106 FLOAT,
	CHARGES_DEDUCTED_AT_DISBURSEMENT FLOAT,
	LOAN_AMOUNT FLOAT,
	DISBURSEMENT_AMOUNT_TILL_DATE FLOAT,
	ROI_AS_ON_REPORTING_DATE FLOAT,
	PARENT_LOAN_TAGGING VARCHAR(255),
	POOL_NAME VARCHAR(255),
	ASSIGNMENT_TAGGING VARCHAR(255),
	PROPERTY_VALUATION_AT_THE_TIME_OF_SANCTION FLOAT,
	LTV FLOAT,
	DLTV FLOAT,
	COMBINED_LTV FLOAT,
	CUSTOMER_NAME VARCHAR(255),
	WHETHER_PMAY_BENEFIT_PROVIDED VARCHAR(255),
	TENURE_AT_THE_TIME_OF_SANCTION FLOAT,
	LISTING_OF_EMPLOYEE_LOANS VARCHAR(255),
	TOTAL_OUTSTANDING FLOAT,
	REMAINING_TENURE_AT_REPORTING_DATE FLOAT,
	CRE_TAGGING VARCHAR(255),
	CRE_RH_TAGGING VARCHAR(255),
	SMA_CLASSIFICATION VARCHAR(255),
	RWA_CLASSIFICATION VARCHAR(255),
	RESTRUCTURE_TAGGING VARCHAR(255),
	OVERDUE_POS FLOAT,
	OVERDUE_INTEREST FLOAT,
	DPD FLOAT,
	ROI_TYPE VARCHAR(255),
	DISBURSAL_STATUS VARCHAR(255),
	UNDISBURSED_AMOUNT FLOAT,
	INTEREST_ACCRUED_BUT_NOT_DUE FLOAT,
	DATE_OF_NPA DATE,
	CUST_ID VARCHAR(255),
	PAN VARCHAR(255),
	PROPERTY_TYPE VARCHAR(255),
	PROPERTY_ADDRESS VARCHAR(1500),
	ADDRESS_1 VARCHAR(1500),
	ADDRESS_2 VARCHAR(1500),
	ADDRESS_3 VARCHAR(1500),
	ADDRESS_4 VARCHAR(1500),
	PLOT_NUMBER VARCHAR(255),
	FLOOR VARCHAR(255),
	LANDMARK VARCHAR(255),
	TEHSIL VARCHAR(255),
	DISTRICT VARCHAR(255),
	COUNTRY VARCHAR(255),
	PINCODE VARCHAR(255),
	PROPERTY_AREA VARCHAR(255),
	LOAN_PURPOSE VARCHAR(255),
	--STAGING VARCHAR(255),
	POOL_ID VARCHAR(255),
	MORATORIUM VARCHAR(255),
	GENDER VARCHAR(255),
	TRANSACTION_STRUCTURE VARCHAR(255),
	NEXT_RESET_DATE DATE,
	PROPERTY_IDENTIFIER VARCHAR(255),
	HL_BIFURCATION_OF__ECL FLOAT,
	NHL_BIFURCATION_OF__ECL FLOAT,
	INTEREST_RECEIVABLE FLOAT,
	INSURANCE_CHARGE_DEDUCTED FLOAT,
	LOAN_AUTHOR_DATE DATE,
	LOAN_NPA_TYPE VARCHAR(20),
	HL_POS FLOAT,
	NHL_POS FLOAT,
	CAR_OUTSTANDING FLOAT,
	REPAYMENT_DURING_MONTH FLOAT,
	PRINCIPAL_REPAYMENT_DURING_MONTH FLOAT,
	INTEREST_REPAYMENT_DURING_MONTH FLOAT,
	OUTSTATNDING_IRAC_PROVISION FLOAT,
	HL_INSURANCE FLOAT,
	EAD_NET_NHL FLOAT,
	CAR_CLASSIFICATION VARCHAR(2500),
	PROVISION_AS_PER_IRACP_NORMS FLOAT,
	HL_PROVISION_AS_PER_IRACP_NORMS FLOAT,
	NHL_PROVISION_AS_PER_IRACP_NORMS FLOAT,
	PROVISION_STATUS VARCHAR(255),
	PROVISIONING_TO_MAINTAIN FLOAT,
	PROVISION_RATE FLOAT,
	PROVISION_ON_RESTUCTURE_2_CASES FLOAT,
	TOTAL_FINAL_PROVISION_AS_PER_IRAC FLOAT
	);

-- STEP 1: DELETE EXISTING DATA FOR CURRENT DATE TO AVOID DUPLICATES
    DELETE FROM DISHA_MART_ANALYTICS.REGULATORY_MART.OUTSTANDING_MART  WHERE REPORT_DATE= LAST_DAY(:START_DATE);

/* SELECT COUNT(*) INTO LOANS_LTV_COUNT FROM DISHA_L2_CURATED.HISTORICAL_LOAD.LOANS_LTV WHERE 	EXTRACTED_DATE=:NEXT_MONTH_START_DATE;

SELECT COUNT(*) INTO IND_ADF_CNT FROM DISHA_L2_CURATED.MANUAL_INGESTION_TABLES.REGULATORY_INDIVIDUAL_ADF WHERE TO_DATE(REPORT_DATE,''DD-MM-YYYY'')=LAST_DAY(:START_DATE);

SELECT COUNT(*) INTO BOLTON_CNT FROM DISHA_L2_CURATED.BOLTON.BREAKUP_LOANS WHERE EFFECTIVE_DATE=LAST_DAY(:START_DATE);

SELECT COUNT(*) INTO CORP_ADF_CNT FROM DISHA_L2_CURATED.BASE_MODEL_DATA.CORP_ADF WHERE REPORT_DATE=LAST_DAY(:START_DATE);

SELECT COUNT(*) INTO RURAL_URBAN_CNT FROM DISHA_L2_CURATED.BASE_MODEL_DATA.RURAL_URBAN_TAGGING  WHERE REPORT_DATE=LAST_DAY(:START_DATE);

select COUNT(*) INTO BOOKING_RPT_CNT from DISHA_L2_CURATED.HISTORICAL_LOAD.BOOKING_REPORT where DATE(extracted_date)=DATEADD(DAY,1,:MONTH_END_DATE);

SELECT  COUNT(*) INTO DUELIST_CNT FROM DISHA_L2_CURATED.HISTORICAL_LOAD.COLL_DUELIST WHERE EXTRACTED_DATE=DATEADD(DAY,1,:MONTH_END_DATE);

----IF Data not present in mandatory files , Return Detailed Error
	IF (DUELIST_CNT = 0) THEN
		SELECT CONCAT(''0 records in DISHA_L2_CURATED.HISTORICAL_LOAD.COLL_DUELIST for EXTRACTED_DATE='',:NEXT_MONTH_START_DATE) INTO :ERROR_MESSAGE;
		
		INSERT INTO DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON
		(PROCEDURE_NAME, TABLE_NAME, EXECUTION_DATE, PREFINAL_CNT, INSERTED_CNT, UPDATED_CNT, UNCHANGED_CNT,STATUS,START_TIME,END_TIME,REMARKS)
		SELECT :PROC_NAME,:TBL_NAME,DATE(:CURR_TIME),:TOTAL_ROWS_IN_PREFINAL,:ROWS_INSERTED,:ROWS_UPDATED,:ROWS_UNCHANGED,''FAIL'',:CURR_TIME,CURRENT_TIMESTAMP,:ERROR_MESSAGE;	
		
		RETURN ''PREFINAL_FAILED: '' || ERROR_MESSAGE;
	
	END IF;
	
	IF (BOOKING_RPT_CNT = 0) THEN
		SELECT CONCAT(''0 records in DISHA_L2_CURATED.HISTORICAL_LOAD.BOOKING_REPORT for EXTRACTED_DATE='',:NEXT_MONTH_START_DATE) INTO :ERROR_MESSAGE;
		
		INSERT INTO DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON
		(PROCEDURE_NAME, TABLE_NAME, EXECUTION_DATE, PREFINAL_CNT, INSERTED_CNT, UPDATED_CNT, UNCHANGED_CNT,STATUS,START_TIME,END_TIME,REMARKS)
		SELECT :PROC_NAME,:TBL_NAME,DATE(:CURR_TIME),:TOTAL_ROWS_IN_PREFINAL,:ROWS_INSERTED,:ROWS_UPDATED,:ROWS_UNCHANGED,''FAIL'',:CURR_TIME,CURRENT_TIMESTAMP,:ERROR_MESSAGE;	
		
		RETURN ''PREFINAL_FAILED: '' || ERROR_MESSAGE;
	
	END IF;
	
	IF (RURAL_URBAN_CNT = 0) THEN
		SELECT CONCAT(''0 records in DISHA_L2_CURATED.BASE_MODEL_DATA.RURAL_URBAN_TAGGING for REPORT_DATE='',:MONTH_END_DATE) INTO :ERROR_MESSAGE;
		
		INSERT INTO DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON
		(PROCEDURE_NAME, TABLE_NAME, EXECUTION_DATE, PREFINAL_CNT, INSERTED_CNT, UPDATED_CNT, UNCHANGED_CNT,STATUS,START_TIME,END_TIME,REMARKS)
		SELECT :PROC_NAME,:TBL_NAME,DATE(:CURR_TIME),:TOTAL_ROWS_IN_PREFINAL,:ROWS_INSERTED,:ROWS_UPDATED,:ROWS_UNCHANGED,''FAIL'',:CURR_TIME,CURRENT_TIMESTAMP,:ERROR_MESSAGE;	
		
		RETURN ''PREFINAL_FAILED: '' || ERROR_MESSAGE;
	
	END IF;
	
	IF(IND_ADF_CNT = 0) THEN
		SELECT CONCAT(''0 records in DISHA_L2_CURATED.MANUAL_INGESTION_TABLES.REGULATORY_INDIVIDUAL_ADF for 
		REPORT_DATE='',:MONTH_END_DATE) INTO :ERROR_MESSAGE;
		
		INSERT INTO DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON
		(PROCEDURE_NAME, TABLE_NAME, EXECUTION_DATE, PREFINAL_CNT, INSERTED_CNT, UPDATED_CNT, UNCHANGED_CNT,STATUS,START_TIME,END_TIME,REMARKS)
		SELECT :PROC_NAME,:TBL_NAME,DATE(:CURR_TIME),:TOTAL_ROWS_IN_PREFINAL,:ROWS_INSERTED,:ROWS_UPDATED,:ROWS_UNCHANGED,''FAIL'',:CURR_TIME,CURRENT_TIMESTAMP,:ERROR_MESSAGE;	
		
		RETURN ''PREFINAL_FAILED: '' || ERROR_MESSAGE;
	
	END IF;
	
	IF (LOANS_LTV_COUNT = 0) THEN
		SELECT CONCAT(''0 records in DISHA_L2_CURATED.HISTORICAL_LOAD.LOANS_LTV for
		EXTRACTED_DATE='',:MONTH_END_DATE) INTO :ERROR_MESSAGE;
		
		INSERT INTO DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON
		(PROCEDURE_NAME, TABLE_NAME, EXECUTION_DATE, PREFINAL_CNT, INSERTED_CNT, UPDATED_CNT, UNCHANGED_CNT,STATUS,START_TIME,END_TIME,REMARKS)
		SELECT :PROC_NAME,:TBL_NAME,DATE(:CURR_TIME),:TOTAL_ROWS_IN_PREFINAL,:ROWS_INSERTED,:ROWS_UPDATED,:ROWS_UNCHANGED,''FAIL'',:CURR_TIME,CURRENT_TIMESTAMP,:ERROR_MESSAGE;	
		
		RETURN ''PREFINAL_FAILED: '' || ERROR_MESSAGE;
	
	END IF;
	
	IF (BOLTON_CNT = 0) THEN
		SELECT CONCAT(''0 records in DISHA_L2_CURATED.BOLTON.BREAKUP_LOANS for 
		EFFECTIVE_DATE='',:MONTH_END_DATE) INTO :ERROR_MESSAGE;
		
		INSERT INTO DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON
		(PROCEDURE_NAME, TABLE_NAME, EXECUTION_DATE, PREFINAL_CNT, INSERTED_CNT, UPDATED_CNT, UNCHANGED_CNT,STATUS,START_TIME,END_TIME,REMARKS)
		SELECT :PROC_NAME,:TBL_NAME,DATE(:CURR_TIME),:TOTAL_ROWS_IN_PREFINAL,:ROWS_INSERTED,:ROWS_UPDATED,:ROWS_UNCHANGED,''FAIL'',:CURR_TIME,CURRENT_TIMESTAMP,:ERROR_MESSAGE;	
		
		RETURN ''PREFINAL_FAILED: '' || ERROR_MESSAGE;
	
	END IF;
	
	IF (CORP_ADF_CNT = 0) THEN
		SELECT CONCAT(''0 records in DISHA_L2_CURATED.BASE_MODEL_DATA.CORP_ADF
		for REPORT_DATE='',:MONTH_END_DATE) INTO :ERROR_MESSAGE;
			
		INSERT INTO DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON
		(PROCEDURE_NAME, TABLE_NAME, EXECUTION_DATE, PREFINAL_CNT, INSERTED_CNT, UPDATED_CNT, UNCHANGED_CNT,STATUS,START_TIME,END_TIME,REMARKS)
		SELECT :PROC_NAME,:TBL_NAME,DATE(:CURR_TIME),:TOTAL_ROWS_IN_PREFINAL,:ROWS_INSERTED,:ROWS_UPDATED,:ROWS_UNCHANGED,''FAIL'',:CURR_TIME,CURRENT_TIMESTAMP,:ERROR_MESSAGE;	
		
		RETURN ''PREFINAL_FAILED: '' || ERROR_MESSAGE;
	END IF;
*/	

    
    -- Step 3: Create temporary table for active loans
    CREATE OR REPLACE TEMPORARY TABLE DISHA_MART_ANALYTICS.REGULATORY_MART.TEMP_OUTSTANDING_MART_ACTIVE_LOANS AS
    SELECT TRIM(LOAN_NO) AS LOAN_NO
    FROM REG_UAT_BACKUP.BASE_MODEL_DATA.LOAN_ACCOUNT_DETAILS A
	LEFT JOIN DISHA_L2_CURATED.HISTORICAL_LOAD.OUTSTANDING_EXCLUDED_LOAN B
	ON TRIM(A.LOAN_NO)=TRIM(B.LOAN_NUMBER_NEW)
    WHERE A.ACTIVATION_FLAG=1
	AND B.LOAN_NUMBER_NEW IS NULL
    AND FIRST_DISBURSAL_DATE <= :MONTH_END_DATE
    AND (LOAN_CLOSURE_DATE IS NULL OR DATE_TRUNC(''MONTH'',DATE(LOAN_CLOSURE_DATE))=:MONTH_START_DATE)
	AND COALESCE(ASSET_CLASS_CODE,''NULL'') <> ''950''
	AND COALESCE(LOAN_STATUS,''NULL'') <> ''10'';
	
	-- Step 4: Create pre-final mart with all required calculations
	CREATE OR REPLACE TEMPORARY TABLE DISHA_MART_ANALYTICS.REGULATORY_MART.OUTSTANDING_MART_PREFINAL(
	LOAN_NUMBER_NEW VARCHAR(255),
	LOAN_NUMBER_OLD VARCHAR(255),
	--IGAAP_POS FLOAT,
	IND_AS_EAD FLOAT,
	ON_BOOK_POS FLOAT,
	TOTAL_POS_AS_PER_LMS FLOAT,
	ECL FLOAT,
	PRODUCT VARCHAR(255),
	SCHEME VARCHAR(255),
	NHB_PRODUCT VARCHAR(255),
	FIRST_DISBURSEMENT_DATE DATE,
	CUSTOMER_TYPE VARCHAR(255),
	ASSET_CLASSIFICATION_IGAAP VARCHAR(255),
	ASSET_CLASSIFICATION_IND_AS VARCHAR(255),
	RURAL_URBAN VARCHAR,
	PROPERTY_STATE VARCHAR(255),
	BRANCH_STATE VARCHAR(255),
	MONTHLY_INCOME_OF_BORROWERS_IN_LOAN FLOAT,
	CASTE_CATEGORY VARCHAR(50),
	TAGGING_OF_NHB_REFINANCE_CASES VARCHAR(50),
	HL_BIFURCATION_OF__EAD FLOAT,
	NHL_BIFURCATION_OF__EAD FLOAT,
	SHRIRAM_PROPERTY_INSURANCE_SC_CODE_160 FLOAT,
	INSURANCE_PREMIUM_HDFC_LIFE_SC_CODE_254 FLOAT,
	CERSAI_REGISTRATION_CHARGES_SC_CODE_1167 FLOAT,
	RCU_CHARGES_SC_CODE_1258 FLOAT,
	ICICI_LIFE_INSURANCE_SC_CODE_442 FLOAT,
	VALUATION_CHARGES_SC_CODE_1122 FLOAT,
	LEGAL_CHARGES_SC_CODE_1123 FLOAT,
	ICICI_LOMBARD_PROPERTY_INSURANCE_SC_CODE_439 FLOAT,
	BHARTI_AXA_LIFE_INSURANCE_SC_CODE_443 FLOAT,
	CARE_HEALTH_INSURANCE_SC_CODE_446 FLOAT,
	ADMINISTRATIVE_FEES_SC_CODE_1441 FLOAT,
	STAMPING_CHARGES_SC_CODE_1120 FLOAT,
	SERVICE_CHARGE_PDD_SC_CODE_1153 FLOAT,
	PROCESSING_FEES_SC_CODE_1106 FLOAT,
	CHARGES_DEDUCTED_AT_DISBURSEMENT FLOAT,
	LOAN_AMOUNT FLOAT,
	DISBURSEMENT_AMOUNT_TILL_DATE FLOAT,
	ROI_AS_ON_REPORTING_DATE FLOAT,
	PARENT_LOAN_TAGGING VARCHAR(255),
	POOL_NAME VARCHAR(255),
	ASSIGNMENT_TAGGING VARCHAR(255),
	PROPERTY_VALUATION_AT_THE_TIME_OF_SANCTION FLOAT,
	LTV FLOAT,
	DLTV FLOAT,
	COMBINED_LTV FLOAT,
	CUSTOMER_NAME VARCHAR(255),
	WHETHER_PMAY_BENEFIT_PROVIDED VARCHAR(255),
	TENURE_AT_THE_TIME_OF_SANCTION FLOAT,
	LISTING_OF_EMPLOYEE_LOANS VARCHAR(255),
	TOTAL_OUTSTANDING FLOAT,
	REMAINING_TENURE_AT_REPORTING_DATE FLOAT,
	CRE_TAGGING VARCHAR(255),
	CRE_RH_TAGGING VARCHAR(255),
	SMA_CLASSIFICATION VARCHAR(255),
	RESTRUCTURE_TAGGING VARCHAR(255),
	OVERDUE_POS FLOAT,
	OVERDUE_INTEREST FLOAT,
	DPD FLOAT,
	ROI_TYPE VARCHAR(255),
	DISBURSAL_STATUS VARCHAR(255),
	UNDISBURSED_AMOUNT FLOAT,
	INTEREST_ACCRUED_BUT_NOT_DUE FLOAT,
	DATE_OF_NPA DATE,
	CUST_ID VARCHAR(255),
	PAN VARCHAR(255),
	PROPERTY_TYPE VARCHAR(255),
	PROPERTY_ADDRESS VARCHAR(1500),
	ADDRESS_1 VARCHAR(1500),
	ADDRESS_2 VARCHAR(1500),
	ADDRESS_3 VARCHAR(1500),
	ADDRESS_4 VARCHAR(1500),
	PLOT_NUMBER VARCHAR(255),
	FLOOR VARCHAR(255),
	LANDMARK VARCHAR(255),
	TEHSIL VARCHAR(255),
	DISTRICT VARCHAR(255),
	COUNTRY VARCHAR(255),
	PINCODE VARCHAR(255),
	PROPERTY_AREA VARCHAR(255),
	LOAN_PURPOSE VARCHAR(255),
	--STAGING VARCHAR(255),
	POOL_ID VARCHAR(255),
	MORATORIUM VARCHAR(255),
	GENDER VARCHAR(255),
	TRANSACTION_STRUCTURE VARCHAR(255),
	NEXT_RESET_DATE DATE,
	PROPERTY_IDENTIFIER VARCHAR(255),
	HL_BIFURCATION_OF__ECL FLOAT,
	NHL_BIFURCATION_OF__ECL FLOAT,
	INTEREST_RECEIVABLE FLOAT,
	INSURANCE_CHARGE_DEDUCTED FLOAT,
	LOAN_AUTHOR_DATE DATE,
	LOAN_NPA_TYPE VARCHAR(20),
	HL_POS FLOAT,
	NHL_POS FLOAT,
	CAR_OUTSTANDING FLOAT,
	POOL_ID_RAW VARCHAR(255),
	REPAYMENT_DURING_MONTH FLOAT,
	PRINCIPAL_REPAYMENT_DURING_MONTH FLOAT,
	INTEREST_REPAYMENT_DURING_MONTH FLOAT,
	OUTSTATNDING_IRAC_PROVISION FLOAT,
	PROD_CATEGORY VARCHAR(20),
	HL_INSURANCE FLOAT,
	EAD_NET_NHL FLOAT,
	CAR_CLASSIFICATION VARCHAR(2500),
	PROVISION_AS_PER_IRACP_NORMS FLOAT,
	RWA_CLASSIFICATION VARCHAR(255),
	HL_PROVISION_AS_PER_IRACP_NORMS FLOAT,
	NHL_PROVISION_AS_PER_IRACP_NORMS FLOAT,
	REPORT_DATE DATE,
	PROVISION_STATUS VARCHAR(255),
	PROVISIONING_TO_MAINTAIN FLOAT,
	PROVISION_RATE FLOAT,
	PROVISION_ON_RESTUCTURE_2_CASES FLOAT,
	TOTAL_FINAL_PROVISION_AS_PER_IRAC FLOAT
)
	AS
	select 	LOAN_NUMBER_NEW,
	LOAN_NUMBER_OLD,
	IND_AS_EAD,
	ON_BOOK_POS,
	TOTAL_POS_AS_PER_LMS,
	ECL,
	PRODUCT,
	SCHEME,
	NHB_PRODUCT,
	FIRST_DISBURSEMENT_DATE,
	CUSTOMER_TYPE,
	ASSET_CLASSIFICATION_IGAAP,
	ASSET_CLASSIFICATION_IND_AS,
	RURAL_URBAN VARCHAR,
	PROPERTY_STATE,
	BRANCH_STATE,
	MONTHLY_INCOME_OF_BORROWERS_IN_LOAN,
	CASTE_CATEGORY,
	TAGGING_OF_NHB_REFINANCE_CASES,
	HL_BIFURCATION_OF__EAD,
	NHL_BIFURCATION_OF__EAD,
	SHRIRAM_PROPERTY_INSURANCE_SC_CODE_160,
	INSURANCE_PREMIUM_HDFC_LIFE_SC_CODE_254,
	CERSAI_REGISTRATION_CHARGES_SC_CODE_1167,
	RCU_CHARGES_SC_CODE_1258,
	ICICI_LIFE_INSURANCE_SC_CODE_442,
	VALUATION_CHARGES_SC_CODE_1122,
	LEGAL_CHARGES_SC_CODE_1123,
	ICICI_LOMBARD_PROPERTY_INSURANCE_SC_CODE_439,
	BHARTI_AXA_LIFE_INSURANCE_SC_CODE_443,
	CARE_HEALTH_INSURANCE_SC_CODE_446,
	ADMINISTRATIVE_FEES_SC_CODE_1441,
	STAMPING_CHARGES_SC_CODE_1120,
	SERVICE_CHARGE_PDD_SC_CODE_1153,
	PROCESSING_FEES_SC_CODE_1106,
	CHARGES_DEDUCTED_AT_DISBURSEMENT,
	LOAN_AMOUNT,
	DISBURSEMENT_AMOUNT_TILL_DATE,
	ROI_AS_ON_REPORTING_DATE,
	PARENT_LOAN_TAGGING,
	POOL_NAME,
	ASSIGNMENT_TAGGING,
	PROPERTY_VALUATION_AT_THE_TIME_OF_SANCTION,
	LTV,
	DLTV,
	COMBINED_LTV,
	CUSTOMER_NAME,
	WHETHER_PMAY_BENEFIT_PROVIDED,
	TENURE_AT_THE_TIME_OF_SANCTION,
	LISTING_OF_EMPLOYEE_LOANS,
	TOTAL_OUTSTANDING,
	REMAINING_TENURE_AT_REPORTING_DATE,
	CRE_TAGGING,
	CRE_RH_TAGGING,
	SMA_CLASSIFICATION,
	RESTRUCTURE_TAGGING,
	OVERDUE_POS,
	OVERDUE_INTEREST,
	DPD,
	ROI_TYPE,
	DISBURSAL_STATUS,
	UNDISBURSED_AMOUNT,
	INTEREST_ACCRUED_BUT_NOT_DUE,
	DATE_OF_NPA,
	CUST_ID,
	PAN,
	PROPERTY_TYPE,
	PROPERTY_ADDRESS,
	ADDRESS_1,
	ADDRESS_2,
	ADDRESS_3,
	ADDRESS_4,
	PLOT_NUMBER,
	FLOOR,
	LANDMARK,
	TEHSIL,
	DISTRICT,
	COUNTRY,
	PINCODE,
	PROPERTY_AREA,
	LOAN_PURPOSE,
	POOL_ID,
	MORATORIUM,
	GENDER,
	TRANSACTION_STRUCTURE,
	NEXT_RESET_DATE,
	PROPERTY_IDENTIFIER,
	HL_BIFURCATION_OF__ECL,
	NHL_BIFURCATION_OF__ECL,
	INTEREST_RECEIVABLE,
	INSURANCE_CHARGE_DEDUCTED,
	LOAN_AUTHOR_DATE,
	LOAN_NPA_TYPE,
	HL_POS,
	NHL_POS,
	CAR_OUTSTANDING,
	POOL_ID_RAW,
	REPAYMENT_DURING_MONTH,
	PRINCIPAL_REPAYMENT_DURING_MONTH,
	INTEREST_REPAYMENT_DURING_MONTH,
	OUTSTATNDING_IRAC_PROVISION,
	PROD_CATEGORY,
	HL_INSURANCE,
	EAD_NET_NHL,
	CAR_CLASSIFICATION,
	PROVISION_AS_PER_IRACP_NORMS,
	RWA_CLASSIFICATION,
	(HL_POS/NULLIF(ON_BOOK_POS,0)) * TOTAL_FINAL_PROVISION_AS_PER_IRAC AS HL_PROVISION_AS_PER_IRACP_NORMS,
	(NHL_POS/NULLIF(ON_BOOK_POS,0)) * TOTAL_FINAL_PROVISION_AS_PER_IRAC AS NHL_PROVISION_AS_PER_IRACP_NORMS,
	:MONTH_END_DATE,
	PROVISION_STATUS,
	PROVISIONING_TO_MAINTAIN,
	PROVISION_RATE,
	PROVISION_ON_RESTUCTURE_2_CASES,
	TOTAL_FINAL_PROVISION_AS_PER_IRAC
	from 
	(
	select *,
	COALESCE(LEAST(INSURANCE_CHARGE_DEDUCTED, (INSURANCE_CHARGE_DEDUCTED / DISBURSEMENT_AMOUNT_TILL_DATE) * HL_BIFURCATION_OF__EAD),0) AS HL_INSURANCE,
	(NHL_BIFURCATION_OF__EAD - (COALESCE(LEAST(INSURANCE_CHARGE_DEDUCTED, (INSURANCE_CHARGE_DEDUCTED / DISBURSEMENT_AMOUNT_TILL_DATE) * HL_BIFURCATION_OF__EAD),0))) AS EAD_NET_NHL,
	CASE
    WHEN UPPER(TRIM(LISTING_OF_EMPLOYEE_LOANS)) = ''EMPLOYEE LOANS'' THEN ''STAFF LOANS''
    WHEN POOL_ID_RAW LIKE ''%PTC%'' THEN ''PTC''
    WHEN UPPER(TRIM(CRE_TAGGING)) = ''Y'' THEN ''CRE''
    WHEN UPPER(TRIM(CRE_RH_TAGGING)) = ''Y'' and LOAN_NPA_TYPE=''STANDARD'' THEN ''CRE-RH''
    WHEN TRIM(prod_category) = ''HL'' and  UPPER(TRIM(CUSTOMER_TYPE))=''INDIVIDUAL'' and LOAN_NPA_TYPE=''STANDARD'' and CAR_OUTSTANDING <= 3000000 AND DLTV <= 80 THEN ''IND-HL-<=30L, LTV <=80%''
    WHEN  TRIM(prod_category) = ''HL'' and  UPPER(TRIM(CUSTOMER_TYPE))=''INDIVIDUAL'' and LOAN_NPA_TYPE=''STANDARD'' and CAR_OUTSTANDING <= 3000000 AND DLTV > 80 AND DLTV <= 90 THEN ''IND-HL-<=30L, LTV 80-90%''
    WHEN TRIM(prod_category) = ''HL'' and  UPPER(TRIM(CUSTOMER_TYPE))=''INDIVIDUAL'' and LOAN_NPA_TYPE=''STANDARD'' and CAR_OUTSTANDING > 3000000 AND CAR_OUTSTANDING <= 7500000 AND DLTV <= 75 AND LOAN_AUTHOR_DATE < ''2017-08-01'' THEN ''IND-HL 30-75L LTV <=75% BEFORE AUG. 17''
    WHEN TRIM(prod_category) = ''HL'' and  UPPER(TRIM(CUSTOMER_TYPE))=''INDIVIDUAL'' and LOAN_NPA_TYPE=''STANDARD'' and CAR_OUTSTANDING > 3000000 AND CAR_OUTSTANDING <= 7500000 AND DLTV > 75 AND DLTV <= 80 AND LOAN_AUTHOR_DATE < ''2017-08-01'' THEN ''INDHL-30-75L, LTV 75-80%, BEFORE AUG. 17''
    WHEN TRIM(prod_category) = ''HL'' and  UPPER(TRIM(CUSTOMER_TYPE))=''INDIVIDUAL'' and LOAN_NPA_TYPE=''STANDARD'' and CAR_OUTSTANDING > 3000000 AND CAR_OUTSTANDING <= 7500000 AND DLTV <= 80 AND LOAN_AUTHOR_DATE >= ''2017-08-01'' THEN ''INDHL-30-75L, LTV <=80%, ON OR AFTER 1 AUG. 17''
    WHEN TRIM(prod_category) = ''HL'' and  UPPER(TRIM(CUSTOMER_TYPE))=''INDIVIDUAL'' and LOAN_NPA_TYPE=''STANDARD'' and CAR_OUTSTANDING > 7500000 AND DLTV <= 75 AND LOAN_AUTHOR_DATE < ''2017-08-01'' THEN ''INDHL >75L LTV <=75%, BEFORE 1 AUG. 17''
    WHEN TRIM(prod_category) = ''HL'' and  UPPER(TRIM(CUSTOMER_TYPE))=''INDIVIDUAL'' and LOAN_NPA_TYPE=''STANDARD'' and CAR_OUTSTANDING > 7500000 AND DLTV <= 75 AND LOAN_AUTHOR_DATE >= ''2017-08-01'' THEN ''INDHL >75L LTV <=75%, AFTER OR 1 AUG. 17''
    WHEN UPPER(TRIM(nhb_product)) = ''OTHER LOAN'' THEN ''NON HOUSING LOANS''
    WHEN UPPER(COALESCE(TRIM(nhb_product),''NULL'')) <> ''OTHER LOAN'' THEN ''OTHER HOUSING LOANS''
    END AS CAR_CLASSIFICATION,
	CASE
        -- Rules 1-5: Provisions based on Asset classification
        WHEN UPPER(TRIM(Asset_classification_IGAAP)) = ''UNI SUBSTANDARD'' 
            THEN ON_BOOK_POS * 0.15
            
        WHEN UPPER(TRIM(Asset_classification_IGAAP)) = ''UNI DOUBTFUL1 <1YR'' 
            THEN ON_BOOK_POS * 0.25
            
        WHEN UPPER(TRIM(Asset_classification_IGAAP)) = ''UNI DOUBTFUL 1YR TO 3 YR'' 
            THEN ON_BOOK_POS * 0.40
            
        WHEN UPPER(TRIM(Asset_classification_IGAAP)) = ''UNDOUBTFL 3 > 3YR'' 
            THEN ON_BOOK_POS * 1.00
            
        WHEN UPPER(TRIM(Asset_classification_IGAAP)) in( ''UNI LOSS'' ,''SARFESI UCRR'')
            THEN ON_BOOK_POS * 1.00
            
        -- Rule 6: Special case for certain products with specific classification
        WHEN UPPER(TRIM(Product)) IN (''OTHER LOANS - MSME'', ''OTHER LOANS - HOME EQUITY'') 
            AND UPPER(TRIM(Asset_classification_IGAAP)) IN (''UNI STANDARD'', ''UNI SMA0'', ''UNI SMA1'', ''UNI SMA2'')
            THEN OUTSTATNDING_IRAC_PROVISION * 0.004
            
        -- Rule 7: CRE-RH tagging provision
        WHEN COALESCE(UPPER(TRIM(Product)),'''') NOT IN (''OTHER LOANS - MSME'', ''OTHER LOANS - HOME EQUITY'') 
            AND UPPER(TRIM(CRE_RH_TAGGING)) = ''Y''
            THEN OUTSTATNDING_IRAC_PROVISION * 0.0075
            
        -- Rule 8: CRE tagging provision
        WHEN COALESCE(UPPER(TRIM(Product)),'''') NOT IN (''OTHER LOANS - MSME'', ''OTHER LOANS - HOME EQUITY'') 
            AND UPPER(TRIM(CRE_tagging)) = ''Y''
            THEN OUTSTATNDING_IRAC_PROVISION * 0.01
            
        -- Rule 9: Corporate customer type provision
        WHEN COALESCE(UPPER(TRIM(Product)),'''') NOT IN (''OTHER LOANS - MSME'', ''OTHER LOANS - HOME EQUITY'') 
            AND UPPER(TRIM(Customer_type)) = ''CORPORATE''
            THEN OUTSTATNDING_IRAC_PROVISION * 0.004
            
        -- Rule 10: Individual customer type provision with weighted calculation
        WHEN COALESCE(UPPER(TRIM(Product)),'''') NOT IN (''OTHER LOANS - MSME'', ''OTHER LOANS - HOME EQUITY'') 
            AND UPPER(TRIM(Customer_type)) = ''INDIVIDUAL''
            THEN (HL_POS / NULLIF(ON_BOOK_POS, 0) * OUTSTATNDING_IRAC_PROVISION * 0.0025) + 
                 (NHL_POS / NULLIF(ON_BOOK_POS, 0) * OUTSTATNDING_IRAC_PROVISION * 0.004)
            
        ELSE 0  -- Default case
    END AS PROVISION_AS_PER_IRACP_NORMS,
	CASE 
    WHEN CAR_CLASSIFICATION IN(''PTC'',''STAFF LOANS'') THEN ''RWA-01''
    WHEN CAR_CLASSIFICATION IN(''IND-HL-<=30L, LTV <=80%'',''INDHL-30-75L, LTV <=80%, ON OR AFTER 1 AUG. 17'',''IND-HL 30-75L LTV <=75% BEFORE AUG. 17'') THEN ''RWA-02''
	WHEN CAR_CLASSIFICATION IN(''IND-HL-<=30L, LTV 80-90%'',''INDHL-30-75L, LTV 75-80%, BEFORE AUG. 17'',''INDHL >75L LTV <=75%, AFTER OR 1 AUG. 17'') THEN ''RWA-03''
	WHEN CAR_CLASSIFICATION IN(''CRE-RH'',''INDHL >75L LTV <=75%, BEFORE 1 AUG. 17'') THEN ''RWA-04''
	WHEN CAR_CLASSIFICATION IN(''CRE'',''NON HOUSING LOANS'',''OTHER HOUSING LOANS'') THEN ''RWA-05''
	END AS RWA_CLASSIFICATION,
    CASE WHEN PROVISION_ON_RESTUCTURE_2_CASES>0 THEN PROVISION_ON_RESTUCTURE_2_CASES ELSE PROVISION_AS_PER_IRACP_NORMS END AS TOTAL_FINAL_PROVISION_AS_PER_IRAC
	from 
	(
	SELECT
	LOAN_NUMBER_NEW,
	LOAN_NUMBER_OLD,
	--CASE WHEN ASSIGNMENT_TAGGING IS NULL THEN TOTAL_POS_AS_PER_LMS ELSE NULL END AS IGAAP_POS,
	IND_AS_EAD,
	ON_BOOK_POS,
	TOTAL_POS_AS_PER_LMS,
	ECL,
	PRODUCT,
	SCHEME,
	NHB_PRODUCT,
	FIRST_DISBURSEMENT_DATE,
	CUSTOMER_TYPE,
	ASSET_CLASSIFICATION_IGAAP,
	ASSET_CLASSIFICATION_IND_AS,
	RURAL_URBAN,
	PROPERTY_STATE,
	BRANCH_STATE,
	MONTHLY_INCOME_OF_BORROWERS_IN_LOAN,
	CASTE_CATEGORY,
	TAGGING_OF_NHB_REFINANCE_CASES,
	HL_BIFURCATION_OF__EAD,
	NHL_BIFURCATION_OF__EAD,
	SHRIRAM_PROPERTY_INSURANCE_SC_CODE_160,
	INSURANCE_PREMIUM_HDFC_LIFE_SC_CODE_254,
	CERSAI_REGISTRATION_CHARGES_SC_CODE_1167,
	RCU_CHARGES_SC_CODE_1258,
	ICICI_LIFE_INSURANCE_SC_CODE_442,
	VALUATION_CHARGES_SC_CODE_1122,
	LEGAL_CHARGES_SC_CODE_1123,
	ICICI_LOMBARD_PROPERTY_INSURANCE_SC_CODE_439,
	BHARTI_AXA_LIFE_INSURANCE_SC_CODE_443,
	CARE_HEALTH_INSURANCE_SC_CODE_446,
	ADMINISTRATIVE_FEES_SC_CODE_1441,
	STAMPING_CHARGES_SC_CODE_1120,
	SERVICE_CHARGE_PDD_SC_CODE_1153,
	PROCESSING_FEES_SC_CODE_1106,
	CHARGES_DEDUCTED_AT_DISBURSEMENT,
	LOAN_AMOUNT,
	DISBURSEMENT_AMOUNT_TILL_DATE,
	ROI_AS_ON_REPORTING_DATE,
	PARENT_LOAN_TAGGING,
	POOL_NAME,
	ASSIGNMENT_TAGGING,
	PROPERTY_VALUATION_AT_THE_TIME_OF_SANCTION,
	LTV,
	DLTV,
	COMBINED_LTV,
	CUSTOMER_NAME,
	WHETHER_PMAY_BENEFIT_PROVIDED,
	TENURE_AT_THE_TIME_OF_SANCTION,
	CASE WHEN UPPER(TRIM(SCHEME))=''EMPLOYEE LOAN'' THEN ''EMPLOYEE LOANS'' ELSE NULL END AS LISTING_OF_EMPLOYEE_LOANS, 
	TOTAL_OUTSTANDING,
	REMAINING_TENURE_AT_REPORTING_DATE,
	CRE_TAGGING,
	CRE_RH_TAGGING,
	SMA_CLASSIFICATION,
	RESTRUCTURE_TAGGING,
	Overdue_POS,
	OVERDUE_INTEREST,
	DPD,
	ROI_TYPE,
	DISBURSAL_STATUS,
	UNDISBURSED_AMOUNT,
	INTEREST_ACCRUED_BUT_NOT_DUE,
	DATE_OF_NPA,
	CUST_ID,
	PAN,
	PROPERTY_TYPE,
	PROPERTY_ADDRESS,
	ADDRESS_1,
	ADDRESS_2,
	ADDRESS_3,
	ADDRESS_4,
	PLOT_NUMBER,
	FLOOR,
	LANDMARK,
	TEHSIL,
	DISTRICT,
	COUNTRY,
	PINCODE,
	PROPERTY_AREA,
	LOAN_PURPOSE,
	--STAGING,
	POOL_ID,
	MORATORIUM,
	GENDER,
	TRANSACTION_STRUCTURE,
	NEXT_RESET_DATE,
	PROPERTY_IDENTIFIER,
	HL_BIFURCATION_OF__ECL,
	NHL_BIFURCATION_OF__ECL,
	INTEREST_RECEIVABLE,
	INSURANCE_CHARGE_DEDUCTED,
	LOAN_AUTHOR_DATE,
	LOAN_NPA_TYPE,
	CASE 
        WHEN TRIM(prod_category) = ''HL'' AND DISBURSEMENT_AMOUNT_TILL_DATE > 0 THEN
            ROUND(ON_BOOK_POS - LEAST(CHARGES_DEDUCTED_AT_DISBURSEMENT,
			((CHARGES_DEDUCTED_AT_DISBURSEMENT / DISBURSEMENT_AMOUNT_TILL_DATE) * ON_BOOK_POS)), 2)
        ELSE 0
    END AS HL_POS,
    CASE 
        WHEN TRIM(prod_category) IN (''NHL'', ''5'') THEN
            ROUND(ON_BOOK_POS, 2)
        WHEN ON_BOOK_POS > 0 THEN
			ROUND(LEAST(CHARGES_DEDUCTED_AT_DISBURSEMENT,
			((CHARGES_DEDUCTED_AT_DISBURSEMENT / DISBURSEMENT_AMOUNT_TILL_DATE) * ON_BOOK_POS)), 2)
        ELSE 0
    END AS NHL_POS,

	/*CASE 
		WHEN UPPER(COALESCE(TRIM(nhb_product),''NULL'')) <> ''OTHER LOAN'' THEN
			LEAST(CHARGES_DEDUCTED_AT_DISBURSEMENT, 
				(CHARGES_DEDUCTED_AT_DISBURSEMENT / NULLIF(DISBURSEMENT_AMOUNT_TILL_DATE, 0)) * ON_BOOK_POS)
		WHEN UPPER(TRIM(nhb_product)) = ''OTHER LOAN'' THEN ON_BOOK_POS
    ELSE 0  END AS NHL_POS,*/
	CASE
    WHEN DISBURSAL_STATUS = ''FULLY DISBURSED'' THEN 
        TOTAL_POS_AS_PER_LMS + INTEREST_RECEIVABLE + ACCRUED_INTEREST
    WHEN DISBURSAL_STATUS = ''PARTIALLY DISBURSED'' THEN 
        TOTAL_POS_AS_PER_LMS + INTEREST_RECEIVABLE + ACCRUED_INTEREST + UNDISBURSED_AMOUNT
    END AS CAR_OUTSTANDING,
	POOL_ID_RAW,
	(PRINCIPAL_REPAYMENT_DURING_MONTH+INTEREST_REPAYMENT_DURING_MONTH+SERVICE_CHARGE_WITHOUT_GST) AS REPAYMENT_DURING_MONTH,
	PRINCIPAL_REPAYMENT_DURING_MONTH,
	INTEREST_REPAYMENT_DURING_MONTH,
	CASE WHEN LOAN_NPA_TYPE=''NPA'' THEN ON_BOOK_POS ELSE (ON_BOOK_POS+
	COALESCE(ADF_INTEREST_OUTSTANDING_ASSIGNED,INTEREST_RECEIVABLE)+INTEREST_ACCRUED_BUT_NOT_DUE) END AS OUTSTATNDING_IRAC_PROVISION,
	prod_category,
	PROVISION_STATUS,
	PROVISIONING_TO_MAINTAIN,
	PROVISION_RATE,
	(COALESCE(OUTSTATNDING_IRAC_PROVISION,0)*PROVISION_RATE*PROVISIONING_TO_MAINTAIN) AS PROVISION_ON_RESTUCTURE_2_CASES
	

FROM
	(
	SELECT 
		TRIM(TAL.LOAN_NO) AS LOAN_NUMBER_NEW,
		COALESCE(LOAN_LTV.ACCRUED_INTEREST,0) AS ACCRUED_INTEREST,
		TRIM(LD.OMNI_LOAN_NO) AS LOAN_NUMBER_OLD,
		COALESCE(DULT.TOTAL_POS,0) AS TOTAL_POS_AS_PER_LMS,
	    CASE WHEN TRIM(LD.PRODUCT_CATEGORY) = ''5'' THEN ''NHL'' ELSE TRIM(LD.PRODUCT_CATEGORY) END AS PROD_CATEGORY,	COALESCE(IND_ADF.PRINCIPAL_OUTSTANDING_ASSIGNED,CORP_ADF.PRINCIPAL_OUTSTANDING_ASSIGNED,DULT.TOTAL_POS,0) AS ON_BOOK_POS,
		BOLT.EAD_LOAN AS IND_AS_EAD,
		BOLT.ECL_LOAN AS ECL,
		TRIM(LD.LOAN_PRODUCT_NAME) AS PRODUCT,
		COALESCE(IND_ADF.INTEREST_OUTSTANDING_ASSIGNED,CORP_ADF.INTEREST_OUTSTANDING_ASSIGNED) AS ADF_INTEREST_OUTSTANDING_ASSIGNED,
		-- Loan Scheme Classification
		CASE 
			WHEN UPPER(TRIM(LD_LIVE.LOAN_SCHEME)) = ''G'' THEN ''GENERAL''
			WHEN UPPER(TRIM(LD_LIVE.LOAN_SCHEME)) = ''EL'' THEN ''EMPLOYEE LOAN''
			WHEN UPPER(TRIM(LD_LIVE.LOAN_SCHEME)) = ''S'' THEN ''STS''
			WHEN UPPER(TRIM(LD_LIVE.LOAN_SCHEME)) = ''AS'' THEN ''ACE STS''
			ELSE ''NOT FOUND'' 
		END AS SCHEME,
		-- NHB Product Classification
		CASE 
			WHEN UPPER(TRIM(LD.LOAN_PRODUCT_NAME)) IN (''OTHER LOANS - MSME'', ''OTHER LOANS - HOME EQUITY'') THEN ''OTHER LOAN''
			WHEN UPPER(TRIM(LD.LOAN_PRODUCT_NAME)) IN (''PURCHASE AND CONSTRUCTION'') THEN ''CONSTRUCTION''
			ELSE UPPER(TRIM(LD.LOAN_PRODUCT_NAME)) 
		END AS NHB_PRODUCT,
		LD.FIRST_DISBURSAL_DATE AS FIRST_DISBURSEMENT_DATE,
		CASE 
			WHEN UPPER(TRIM(CUST_DTL_FLEX.CUSTOMER_TYPE)) = ''I'' THEN ''INDIVIDUAL''
			WHEN UPPER(TRIM(CUST_DTL_FLEX.CUSTOMER_TYPE)) = ''C'' THEN ''CORPORATE'' 
			ELSE NULL 
		END AS CUSTOMER_TYPE,
		LD.ASSET_CLASS_DESC AS ASSET_CLASSIFICATION_IGAAP,
		CASE WHEN TRIM(LD.LOAN_STATUS) IN(''11'',''1'',''5'') THEN ''CLOSED'' 
			 WHEN UPPER(TRIM(LD.ASSET_CLASS_DESC)) IN (''UNI STANDARD'', ''UNI SMA0'', ''UNI SMA1'', ''UNI SMA2'')
			 THEN ''STANDARD'' ELSE ''NPA'' END AS LOAN_NPA_TYPE,
		BOLT.FINAL_STAGING AS ASSET_CLASSIFICATION_IND_AS,
		COALESCE(RUT.RURAL_URBAN,PREV_MONTH.RURAL_URBAN) AS RURAL_URBAN,
		BooK_RT.PROPERTY_STATE,
		LD.BRANCH_STATE,
		CASE WHEN (CR.MONTHLY_INCOME_ASSESSED IS NULL OR CR.MONTHLY_INCOME_ASSESSED IS NULL=0) THEN MTH_INCOME.INCOME END AS MONTHLY_INCOME_OF_BORROWERS_IN_LOAN,
		LAD.CASTE_CATEGORY,
		COALESCE(LD.POOL_NAME,LD.NHB_REFINANCE_FLG) AS TAGGING_OF_NHB_REFINANCE_CASES,
		BOLT.EAD_HL AS HL_BIFURCATION_OF__EAD,
		BOLT.EAD_NHL AS NHL_BIFURCATION_OF__EAD,
		COALESCE(CCM.SHRIRAM_PROPERTY_INSURANCE_SC_CODE_160,0) AS SHRIRAM_PROPERTY_INSURANCE_SC_CODE_160,
		COALESCE(CCM.INSURANCE_PREMIUM_HDFC_LIFE_SC_CODE_254,0) AS INSURANCE_PREMIUM_HDFC_LIFE_SC_CODE_254,
		COALESCE(CCM.CERSAI_REGISTRATION_CHARGES,0) AS CERSAI_REGISTRATION_CHARGES_SC_CODE_1167,
		COALESCE(CCM.RCU_CHARGES_SC_CODE_1258,0) AS RCU_CHARGES_SC_CODE_1258,
		COALESCE(CCM.ICICI_LIFE_INSURANCE_SC_CODE_442,0) AS ICICI_LIFE_INSURANCE_SC_CODE_442,
		COALESCE(CCM.VALUATION_CHARGES_SC_CODE_1122,0) AS VALUATION_CHARGES_SC_CODE_1122,
		COALESCE(CCM.LEGAL_CHARGES_SC_CODE_1123,0) AS LEGAL_CHARGES_SC_CODE_1123,
		COALESCE(CCM.ICICI_LOMBARD_PROPERTY_INSURANCE_SC_CODE_439,0) AS ICICI_LOMBARD_PROPERTY_INSURANCE_SC_CODE_439,
		COALESCE(CCM.BHARTI_AXA_LIFE_INSURANCE_SC_CODE_443,0) AS BHARTI_AXA_LIFE_INSURANCE_SC_CODE_443,
		COALESCE(CCM.CARE_HEALTH_INSURANCE_SC_CODE_446,0) AS CARE_HEALTH_INSURANCE_SC_CODE_446,
		COALESCE(CCM.ADMINISTRATIVE_FEES_SC_CODE_1441,0) AS ADMINISTRATIVE_FEES_SC_CODE_1441,
		COALESCE(CCM.STAMPING_CHARGES_SC_CODE_1120,0) AS STAMPING_CHARGES_SC_CODE_1120,
		COALESCE(CCM.SERVICE_CHARGE_PDD_SC_CODE_1153,0) AS SERVICE_CHARGE_PDD_SC_CODE_1153,
		COALESCE(CCM.PROCESSING_FEES_SC_CODE_1106,0) AS PROCESSING_FEES_SC_CODE_1106,
		COALESCE(CCM.CHARGES_DEDUCTED_AT_DISBURSEMENT,0) AS CHARGES_DEDUCTED_AT_DISBURSEMENT,
		LD.LOAN_SANCTION_AMOUNT AS LOAN_AMOUNT,
		LD.DISB_AMOUNT AS DISBURSEMENT_AMOUNT_TILL_DATE,
		BOOK_RT.RATE_OF_INTEREST AS ROI_AS_ON_REPORTING_DATE,
		PARENT_LOAN.PRIMARY_ACCT AS PARENT_LOAN_TAGGING,
		COALESCE(LD.POOL_NAME,LD.POOL_NAME_NHB) AS POOL_NAME,
		CASE WHEN LD.POOL_ID IS NOT NULL THEN ''YES'' ELSE ''NO'' END AS ASSIGNMENT_TAGGING,
		COALESCE(BOOK_RT.ASSET_COLLATERAL_VALUE,0) AS PROPERTY_VALUATION_AT_THE_TIME_OF_SANCTION,
		LD.LTV_PERC AS LTV,
		LOAN_LTV.DLTV,
		LD.COMBINED_LTV AS COMBINED_LTV,
		UPPER(TRIM(CUST_DTL_FLEX.CUST_NAME)) AS CUSTOMER_NAME,
		LD.CREDIT_SUBSIDY_FLG AS WHETHER_PMAY_BENEFIT_PROVIDED,
		LD.LOAN_TENURE AS TENURE_AT_THE_TIME_OF_SANCTION,
		DULT.TOTAL_POS + DULT.OVERDUE_INTEREST + DULT.PRE_EMI AS TOTAL_OUTSTANDING,
		BOOK_RT.REMAINING_TENURE AS REMAINING_TENURE_AT_REPORTING_DATE,
		LD_LIVE.CRE_TAGGING AS CRE_TAGGING,
		LD_LIVE.CRE_RH_TAGGING AS CRE_RH_TAGGING,
		LD.ASSET_CLASS_DESC AS SMA_CLASSIFICATION,
		NULL AS RESTRUCTURE_TAGGING,
		DULT.OVERDUE_PRIN AS Overdue_POS,
		DULT.OVERDUE_INTEREST AS OVERDUE_INTEREST,
		LD.MAXIMUM_DPD AS DPD,
		LD.LOAN_RATE_METHOD AS ROI_TYPE,
		CASE 
			WHEN LD.DISB_AMOUNT=0 THEN ''NOT DISBURSED''
			WHEN LD.LOAN_SANCTION_AMOUNT > LD.DISB_AMOUNT THEN ''PARTIALLY DISBURSED'' 
			ELSE ''FULLY DISBURSED'' 
        END AS DISBURSAL_STATUS,
		CASE 
			WHEN TRIM(LD.LOAN_STATUS) IN(''11'',''1'',''5'') THEN 0
			ELSE (COALESCE(LD.LOAN_SANCTION_AMOUNT,0) - COALESCE(LD.DISB_AMOUNT,0)) END AS UNDISBURSED_AMOUNT,
		COALESCE(GL_TX_DTL.INTEREST_ACCRUED_BUT_NOT_DUE,0) AS INTEREST_ACCRUED_BUT_NOT_DUE,
		CASE WHEN LD.NPA_DATE=''1950-01-01'' or LD.NPA_DATE IS NULL THEN MANUAL_NPA.NPA_DATE ELSE LD.NPA_DATE END AS DATE_OF_NPA,
		LD.CUST_ID_FLEX AS CUST_ID,
		COALESCE(CUST_DTL.CUST_PAN,CUST_DTL_FLEX.PAN_NUMBER) AS PAN,
		COALESCE(COLLATERAL_DF.PROPERTY_TYPE,LOAN_DUMP.PROPERTY_TYPE,'''') AS PROPERTY_TYPE,
		LOAN_DUMP.PROPERTY_ADDRESS,
		COLLATERAL_DF.ADDRESS_1,
		COLLATERAL_DF.ADDRESS_2,
		COLLATERAL_DF.ADDRESS_3,
		COLLATERAL_DF.ADDRESS_4,
		COLLATERAL_DF.PLOT_NUMBER,
		COLLATERAL_DF.FLOOR,
		COLLATERAL_DF.LANDMARK,
		COLLATERAL_DF.TEHSIL,
		COLLATERAL_DF.DISTRICT,
		COLLATERAL_DF.COUNTRY,
		COLLATERAL_DF.PINCODE,
		COLLATERAL_DF.PROPERTY_AREA,
		CASE 
			WHEN UPPER(TRIM(LD.TYPE_LOAN)) IN( ''NEW LOAN'',''BALANCE TRANSFER'',''ADDITIONAL FUNDING'') THEN UPPER(TRIM(LD.TYPE_LOAN))
			ELSE ''UNKNOWN'' END AS LOAN_PURPOSE,

		--BOLT.FINAL_STAGING AS STAGING,
		LD.POOL_ID AS POOL_ID,
		LD.POOL_ID AS POOL_ID_RAW,
		
		NULL AS MORATORIUM,
		-- GENDER MAPPING
		CASE 
			WHEN UPPER(TRIM(CUST_DTL_FLEX.CUST_GENDER)) = ''F'' THEN ''FEMALE''
			WHEN UPPER(TRIM(CUST_DTL_FLEX.CUST_GENDER)) = ''M'' THEN ''MALE''
			ELSE NULL 
		END AS GENDER,
		UPPER(TRIM(LD.TRANSACTION_STRUCTURE)) AS TRANSACTION_STRUCTURE,
		LD.NEXT_RESET_DATE AS NEXT_RESET_DATE,
        UPPER(TRIM(PROPERTY_IDENTIFIER)) AS PROPERTY_IDENTIFIER,
		BOLT.ECL_HL AS HL_BIFURCATION_OF__ECL,
		BOLT.ECL_NHL AS NHL_BIFURCATION_OF__ECL,
		COALESCE(DULT.OVERDUE_INTEREST,0) + COALESCE(DULT.PRE_EMI,0) AS INTEREST_RECEIVABLE,
		(COALESCE(CCM.SHRIRAM_PROPERTY_INSURANCE_SC_CODE_160,0) +COALESCE(CCM.INSURANCE_PREMIUM_HDFC_LIFE_SC_CODE_254,0)+ COALESCE(CCM.ICICI_LIFE_INSURANCE_SC_CODE_442,0) + COALESCE(CCM.ICICI_LOMBARD_PROPERTY_INSURANCE_SC_CODE_439,0) + COALESCE(CCM.BHARTI_AXA_LIFE_INSURANCE_SC_CODE_443,0) + COALESCE(CCM.CARE_HEALTH_INSURANCE_SC_CODE_446,0) + COALESCE(CCM.BAJAJ_ALLIANZ,0) + COALESCE(CCM.BAJAJ_ALLIANZ_GENERAL,0) + COALESCE(CCM.KOTAK_ORACLE,0)+COALESCE(CCM.FUTURE_GENERALI_INSURANCE, 0)+COALESCE(CCM.ICICI_LOMBARD_GIC_LIMITED, 0)+COALESCE(CCM.INSURANCE, 0)+COALESCE(CCM.LOAN_SURAKSHA, 0)+COALESCE(CCM.RELIGARE_HEALTH_INSURANCE_CO, 0)) AS INSURANCE_CHARGE_DEDUCTED,
		LOAN_INITIATION_DATE AS LOAN_AUTHOR_DATE,	(COALESCE(PREV_MONTH.TOTAL_POS_AS_PER_LMS,0)+COALESCE(DISB_AMT.DISBURSAL_DURING_MONTH,0)-COALESCE(CANCl.DISBURSAL_AMT,0)-COALESCE(DULT.TOTAL_POS,0)-COALESCE(ACCT_WRITEOFF.WRITEOFF_AMT,0))AS PRINCIPAL_REPAYMENT_DURING_MONTH,
		(COALESCE(PREV_MONTH.INTEREST_RECEIVABLE,0)- COALESCE(INT_WAIVED.INTEREST_WAIVED_AMT,0)-COALESCE(DULT.OVERDUE_INTEREST,0)-COALESCE(DULT.PRE_EMI,0)+COALESCE(LN_INT.INTEREST_DUE,0)) AS INTEREST_REPAYMENT_DURING_MONTH,
		TRIM(OLP.PROVISION_STATUS) AS PROVISION_STATUS,
		COALESCE(OLP.PROVISIONING_TO_MAINTAIN,0) AS PROVISIONING_TO_MAINTAIN,
		CASE WHEN LOAN_NPA_TYPE=''STANDARD'' AND UPPER(TRIM(OLP.PROVISION_STATUS))=''REGULAR'' THEN 0.1
			 WHEN LOAN_NPA_TYPE=''STANDARD'' AND UPPER(TRIM(OLP.PROVISION_STATUS))=''ADDITIONAL'' THEN 0.15
			 ELSE 0 END AS PROVISION_RATE,
		COALESCE(GL_SC.INCOME_SC,0) AS SERVICE_CHARGE_WITHOUT_GST
	FROM 
	(SELECT * FROM REG_UAT_BACKUP.BASE_MODEL_DATA.LOAN_ACCOUNT_DETAILS WHERE ACTIVATION_FLAG=1) LD 
	RIGHT JOIN DISHA_MART_ANALYTICS.REGULATORY_MART.TEMP_OUTSTANDING_MART_ACTIVE_LOANS TAL ON TRIM(LD.LOAN_NO)=TRIM(TAL.LOAN_NO)
	---COLLATERAL DETAILS
	LEFT JOIN (SELECT * FROM DISHA_L2_CURATED.HISTORICAL_LOAD.OUTSTANDING_LOAN_PROVISION) OLP ON
	TRIM(LD.LOAN_NO)=TRIM(OLP.LOAN_NO)
	LEFT JOIN 
	(SELECT COD_ACCT_NO,MAX(CREDIT),MIN(DEBIT),COALESCE(MAX(CREDIT),0)-COALESCE(MIN(DEBIT),0) AS INCOME_SC
	FROM (
	SELECT trim(cod_acct_no) AS cod_acct_no , SUM(CASE WHEN TRIM(COD_DRCR)=''C'' THEN AMT_TXN_LCY END) AS CREDIT , 
	SUM(CASE WHEN TRIM(COD_DRCR)=''D'' THEN AMT_TXN_LCY END) AS  DEBIT 
	FROM (SELECT * FROM REG_UAT_BACKUP.FLEX_LMS.XF_STCAP_GL_TXNS_MMDD WHERE ACTIVATION_FLAG=1 and DAT_TXN_POSTING 
	BETWEEN :MONTH_START_DATE AND :MONTH_END_DATE) A
	INNER JOIN
	(SELECT COD_GL_SC_INCOME FROM REG_UAT_BACKUP.FLEX_LMS.BA_SC_CODE WHERE FLG_MNT_STATUS=''A'' AND ACTIVATION_FLAG=1 GROUP BY 1)B ON A.COD_GL_ACCT=B.COD_GL_SC_INCOME
	GROUP BY 1
	)
	GROUP BY 1) GL_SC ON 
	TRIM(LD.LOAN_NO)=TRIM(GL_SC.COD_ACCT_NO)
	LEFT JOIN(SELECT LOAN_NO,CRE_TAGGING,CRE_RH_TAGGING,LOAN_SCHEME FROM DISHA_L2_CURATED.BASE_MODEL_DATA.LOAN_ACCOUNT_DETAILS WHERE ACTIVATION_FLAG=1) LD_LIVE
	ON TRIM(LD_LIVE.LOAN_NO)=TRIM(TAL.LOAN_NO)
	LEFT JOIN (SELECT COD_ACCT_NO, COALESCE(MAX(CASE WHEN TRIM(COD_ACCT_NO)<>TRIM(PRIMARY_ACCT) THEN TRIM(PRIMARY_ACCT) END),MAX(TRIM(PRIMARY_ACCT))) AS PRIMARY_ACCT FROM REG_UAT_BACKUP.BASE_MODEL_DATA.VWE_LN_X_LOAN_COLLATERAL_LINKAGE 
	WHERE ACTIVATION_FLAG=1 GROUP BY COD_ACCT_NO)PARENT_LOAN
	ON TRIM(PARENT_LOAN.COD_ACCT_NO)=TRIM(TAL.LOAN_NO)
	LEFT JOIN(SELECT LOAN_ACCOUNT_NUMBER,DLTV,ACCRUED_INTEREST FROM DISHA_L2_CURATED.HISTORICAL_LOAD.LOANS_LTV WHERE EXTRACTED_DATE=:NEXT_MONTH_START_DATE GROUP BY LOAN_ACCOUNT_NUMBER,DLTV,ACCRUED_INTEREST) LOAN_LTV
	ON TRIM(LOAN_LTV.LOAN_ACCOUNT_NUMBER)=TRIM(TAL.LOAN_NO)
	LEFT JOIN
	(SELECT LOAN_NUMBER_NEW,TOTAL_POS_AS_PER_LMS,INTEREST_RECEIVABLE,RURAL_URBAN FROM DISHA_MART_ANALYTICS.REGULATORY_MART.OUTSTANDING_MART WHERE REPORT_DATE=DATEADD(DAY,-1,:MONTH_START_DATE)) PREV_MONTH
	ON TRIM(PREV_MONTH.LOAN_NUMBER_NEW)=TRIM(TAL.LOAN_NO)
	LEFT JOIN
	(SELECT  COD_ACCT_NO,DATE(DAT_POST) AS NPA_DATE FROM REG_UAT_BACKUP.FLEX_LMS.LN_X_ACCT_NPA_DTLS WHERE ACTIVATION_FLAG=1)MANUAL_NPA
	ON TRIM(TAL.LOAN_NO)=TRIM(MANUAL_NPA.COD_ACCT_NO)
	LEFT JOIN
	(SELECT COD_ACCT_NO,SUM(AMT_TXN_ACY) AS INTEREST_WAIVED_AMT FROM REG_UAT_BACKUP.FLEX_LMS.LN_ARREAR_TXN_HIST 
	WHERE DATE_TRUNC(''MONTH'',DATE(DAT_POST))=:MONTH_START_DATE
	AND ((TRIM(COD_TXN_MNEMONIC) in(''4630'',''4640'') AND TRIM(COD_ARREAR_TYPE) IN(''I'',''N'') AND TRIM(COD_DRCR)=''C'')
	OR (TRIM(COD_TXN_MNEMONIC) in(''3630'') AND TRIM(COD_ARREAR_TYPE) IN(''I'',''N'') AND TRIM(COD_DRCR) IN (''C'',''D'')))
	GROUP BY COD_ACCT_NO) INT_WAIVED
	ON TRIM(INT_WAIVED.COD_ACCT_NO)=TRIM(TAL.LOAN_NO)
	LEFT JOIN
	(SELECT COD_ACCT_NO,SUM(AMT_WRITEOFF_PRINC_BAL) AS WRITEOFF_AMT FROM REG_UAT_BACKUP.FLEX_LMS.AC_ACCT_WRITEOFF WHERE DATE_TRUNC(''MONTH'',DATE(DAT_WRITEOFF))=:MONTH_START_DATE AND ACTIVATION_FLAG=1 GROUP BY COD_ACCT_NO) ACCT_WRITEOFF
	ON TRIM(ACCT_WRITEOFF.COD_ACCT_NO)=TRIM(TAL.LOAN_NO)
	LEFT JOIN
	(SELECT COD_ACCT_NO,SUM(AMT_TXN_ACY) AS INTEREST_DUE FROM REG_UAT_BACKUP.FLEX_LMS.LN_ARREAR_TXN_HIST 
	WHERE DATE_TRUNC(''MONTH'',DATE(DAT_POST))=:MONTH_START_DATE
	AND TRIM(COD_TXN_MNEMONIC) in(''4310'') AND TRIM(COD_ARREAR_TYPE) IN(''I'',''N'') AND TRIM(COD_DRCR)=''D''
	GROUP BY COD_ACCT_NO) LN_INT
	/*(SELECT COD_ACCT_NO ,SUM(AMT_INTEREST) AS INTEREST_DUE FROM REG_UAT_BACKUP.FLEX_LMS.LN_ACCT_SCHEDULE_DETLS WHERE ACTIVATION_FLAG=1 AND DATE_TRUNC(''MONTH'',DATE(DATE_INSTAL))=:MONTH_START_DATE GROUP BY COD_ACCT_NO) LN_INT*/
	ON TRIM(LN_INT.COD_ACCT_NO)=TRIM(TAL.LOAN_NO)
	LEFT JOIN
	(SELECT COD_ACCT_NO, SUM(AMT_DISBURSED) AS DISBURSAL_DURING_MONTH
	FROM (SELECT * FROM REG_UAT_BACKUP.FLEX_LMS.LN_DISB_LOG_HIST QUALIFY ROW_NUMBER() OVER(PARTITION BY COD_ACCT_NO,CTR_DISB ORDER BY DATE(DAT_DISB) DESC)=1)
	WHERE DATE(DAT_DISB) BETWEEN :MONTH_START_DATE AND :MONTH_END_DATE
		AND ACTIVATION_FLAG=1
    AND CONCAT(TRIM(COD_ACCT_NO), ''-'', TRIM(CTR_DISB)) NOT IN (
        ''241202903502781-2'',
        ''241200504001358-1'',
        ''241219004015136-1'',
        ''231219103352634-4'',
        ''231203603383813-4'',
        ''241207503494348-4'')
		GROUP BY COD_ACCT_NO) DISB_AMT
	ON TRIM(DISB_AMT.COD_ACCT_NO)=TRIM(TAL.LOAN_NO)
	LEFT JOIN
	(SELECT * FROM DISHA_MART_ANALYTICS.REGULATORY_MART.CANCELLED where REPORT_DATE=:MONTH_END_DATE) CANCl
	ON TRIM(TAL.LOAN_NO)=TRIM(CANCl.loan_no)
	LEFT JOIN
	(SELECT LOAN_NO, TYPE_OF_PROPERTY_SFDC AS PROPERTY_TYPE, PROPERTY_FULL_ADDRESS AS PROPERTY_ADDRESS
	FROM DISHA_MART_ANALYTICS.REGULATORY_MART.LOAN_DUMP_MART WHERE REPORT_DATE=:MONTH_END_DATE) LOAN_DUMP
	ON TRIM(TAL.LOAN_NO)=TRIM(LOAN_DUMP.loan_no)
	LEFT JOIN (
	SELECT A.LOAN_NO,A.PROPERTY_COST_PRICE,A.ADDRESS_1,A.ADDRESS_2,A.ADDRESS_3,
	A.ADDRESS_4,A.PLOT_NUMBER,A.FLOOR,A.LANDMARK,A.TEHSIL,A.DISTRICT,A.COUNTRY,A.PINCODE,A.PROPERTY_AREA ,B.PROPERTY_TYPE
	FROM
	(SELECT 
			LOAN_NO,
			PROPERTY_COST_PRICE,
			/*CASE WHEN (COLLATERAL_TYPE_CODE=1  AND COLLATERAL_CODE IN (101,109,106,104)) THEN ''TOP-02''
				 WHEN (COLLATERAL_TYPE_CODE=1  AND COLLATERAL_CODE IN (107,105,108,118)) THEN ''TOP-04''
				 WHEN (COLLATERAL_TYPE_CODE=1  AND COLLATERAL_CODE IN (102,103))THEN ''TOP-03''
			ELSE '''' END AS PROPERTY_TYPE,*/
			ADDRESS_LINE1 AS ADDRESS_1,
			ADDRESS_LINE2 AS ADDRESS_2,
			ADDRESS_LINE3 AS ADDRESS_3,
			ADDRESS_LINE4 AS ADDRESS_4,
			PLOT_NUMBER,
			FLOOR_NO AS "FLOOR",
			LANDMARK,
			TEHSIL,
			DISTRICT,
			COUNTRY,
			PINCODE,
			PROPERTY_AREA
		FROM REG_UAT_BACKUP.BASE_MODEL_DATA.COLLATERAL_DETAILS_FLEXCUBE
		WHERE ACTIVATION_FLAG=1
			AND COLLATERAL_SECURED_FLAG = ''P''
		QUALIFY ROW_NUMBER() OVER (PARTITION BY LOAN_NO ORDER BY COLLATERAL_ID DESC) = 1)A
		INNER JOIN
		(SELECT LOAN_NO,LISTAGG(COALESCE(PROPERTY_TYPE,''NULL''),''|'') AS PROPERTY_TYPE
		FROM REG_UAT_BACKUP.BASE_MODEL_DATA.COLLATERAL_DETAILS_FLEXCUBE
		WHERE ACTIVATION_FLAG=1
		AND COLLATERAL_SECURED_FLAG = ''P''
		GROUP BY LOAN_NO
		)B
		ON TRIM(A.LOAN_NO)=TRIM(B.LOAN_NO)
		
	) COLLATERAL_DF ON TRIM(TAL.LOAN_NO) = TRIM(COLLATERAL_DF.LOAN_NO)
	---LOAN APPLICATION DETAILS
	LEFT JOIN (
		SELECT 
			UNIQUE_SYS_ID,
			CASTE_CATEGORY,
			CASE
				WHEN LENGTH(TRIM(LOAN_APPLICATION_IDV)) = 15 AND SUBSTRING(TRIM(LOAN_APPLICATION_IDV),9,6) <> ''000000'' 
					THEN SUBSTRING(TRIM(LOAN_APPLICATION_IDV),9,6)
				WHEN SUBSTRING(TRIM(LOAN_APPLICATION_IDV),9,6) = ''000000'' 
					THEN SUBSTRING(TRIM(LMS_LOAN_NO),15,6) 
				ELSE TRIM(LOAN_APPLICATION_IDV)
			END AS RES_LOAN_IDV
		FROM REG_UAT_BACKUP.BASE_MODEL_DATA.LOAN_APPLICATION_DETAILS_TRANS 
		WHERE ACTIVATION_FLAG=1
		QUALIFY ROW_NUMBER() OVER( PARTITION BY 
			(CASE
                WHEN LENGTH(TRIM(LOAN_APPLICATION_IDV)) = 15 
                AND SUBSTRING(TRIM(LOAN_APPLICATION_IDV), 9, 6) <> ''000000'' 
                    THEN SUBSTRING(TRIM(LOAN_APPLICATION_IDV), 9, 6)
                WHEN SUBSTRING(TRIM(LOAN_APPLICATION_IDV), 9, 6) = ''000000'' 
                    THEN SUBSTRING(TRIM(LMS_LOAN_NO), 15, 6) 
                ELSE TRIM(LOAN_APPLICATION_IDV)
            END) ORDER BY LENGTH(TRIM(LOAN_APPLICATION_IDV)) DESC)=1
		) LAD ON TRIM(LAD.RES_LOAN_IDV) = SUBSTRING(TAL.LOAN_NO, 9, 6)
	LEFT JOIN (
			SELECT COALESCE(NULLIF(MAX(INCOME1_MAX),0),MAX(INCOME2_MAX)) AS MONTHLY_INCOME_ASSESSED,
				RES_LOAN_IDV
				FROM(
				SELECT 
                INCOME1_MAX,INCOME2_MAX,
                CASE
                    WHEN LENGTH(TRIM(LOAN_APPLICATION_IDV)) = 15 
					AND SUBSTRING(TRIM(LOAN_APPLICATION_IDV),9,6) <> ''000000'' 
                        THEN SUBSTRING(TRIM(LOAN_APPLICATION_IDV),9,6)
                    WHEN SUBSTRING(TRIM(LOAN_APPLICATION_IDV),9,6) = ''000000'' 
                        THEN SUBSTRING(TRIM(LMS_LOAN_NO),15,6) 
                    ELSE TRIM(LOAN_APPLICATION_IDV)
                END AS RES_LOAN_IDV
            FROM REG_UAT_BACKUP.BASE_MODEL_DATA.LOAN_APPLICATION_DETAILS_TRANS WHERE ACTIVATION_FLAG=1 AND COALESCE(INCOME1_MAX,INCOME2_MAX)  IS NOT NULL
		--Qualify logic to be removed once issue resolved 
			QUALIFY ROW_NUMBER() OVER( PARTITION BY 
			(CASE
                    WHEN LENGTH(TRIM(LOAN_APPLICATION_IDV)) = 15 
					AND SUBSTRING(TRIM(LOAN_APPLICATION_IDV),9,6) <> ''000000'' 
                        THEN SUBSTRING(TRIM(LOAN_APPLICATION_IDV),9,6)
                    WHEN SUBSTRING(TRIM(LOAN_APPLICATION_IDV),9,6) = ''000000'' 
                        THEN SUBSTRING(TRIM(LMS_LOAN_NO),15,6) 
                    ELSE TRIM(LOAN_APPLICATION_IDV)
                END) ORDER BY LENGTH(LOAN_APPLICATION_IDV) DESC)=1
				)A
				GROUP BY 
				RES_LOAN_IDV
		
            --SELECT MONTHLY_INCOME_ASSESSED, LOAN_APPLICATION_ID 
            --FROM REG_UAT_BACKUP.BASE_MODEL_DATA.CREDIT_REVIEW WHERE ACTIVATION_FLAG=1  AND MONTHLY_INCOME_ASSESSED IS NOT NULL
			--QUALIFY ROW_NUMBER() OVER(PARTITION BY LOAN_APPLICATION_ID ORDER BY LAST_MODIFIED_DATE DESC)=1
		
	) CR ON  TRIM(CR.RES_LOAN_IDV) = SUBSTRING(TRIM(TAL.LOAN_NO), 9, 6)
	LEFT JOIN (SELECT LAN_new ,income from REG_UAT_BACKUP.BASE_MODEL_DATA.CR_MONTHLY_INCOME_DETAILS where LAN_NEW is not null) MTH_INCOME
	ON TRIM(TAL.LOAN_NO)=TRIM(MTH_INCOME.LAN_new)
	LEFT JOIN(
			SELECT *
            FROM REG_UAT_BACKUP.BASE_MODEL_DATA.CHARGES_CONSOLIDATED_ORACLE 
			WHERE LOAN_NUMBER_NEW IS NOT NULL
            AND ACTIVATION_FLAG=1) CCM 
		ON TRIM(CCM.LOAN_NUMBER_NEW) = TRIM(TAL.LOAN_NO)
	LEFT JOIN (
		SELECT * FROM REG_UAT_BACKUP.BASE_MODEL_DATA.CUSTOMER_DETAILS_FLEXCUBE 
		WHERE ACTIVATION_FLAG=1
		
		) CUST_DTL_FLEX
		ON TRIM(CUST_DTL_FLEX.CUST_ID_FLEX) =TRIM(LD.CUST_ID_FLEX) 
		
	LEFT JOIN ( SELECT CAST(SUBSTRING(CUSTOMER_ID,4,8) AS INT)AS CUST_ID ,CUST_PAN from REG_UAT_BACKUP.BASE_MODEL_DATA.CUSTOMER_DETAILS
WHERE ACTIVATION_FLAG=1)CUST_DTL
	ON TRIM(CUST_DTL.CUST_ID) =TRIM(LD.CUST_ID_FLEX)
	LEFT JOIN (
		SELECT LOAN_NO, sum(arrear_amt_due) as Overdue_POS 
		FROM REG_UAT_BACKUP.BASE_MODEL_DATA.PAYMENT_DETAILS 
		WHERE arrear_type = ''C'' 
		AND ACTIVATION_FLAG=1 GROUP BY LOAN_NO) PD
		ON TRIM(PD.LOAN_NO)=TRIM(TAL.LOAN_NO)
	LEFT JOIN (SELECT * FROM DISHA_L2_CURATED.MANUAL_INGESTION_TABLES.REGULATORY_INDIVIDUAL_ADF  WHERE TO_DATE(REPORT_DATE,''DD-MM-YYYY'')=LAST_DAY(:START_DATE)) IND_ADF
		ON TRIM(TAL.LOAN_NO)=TRIM(IND_ADF.LOAN_NO)
	LEFT JOIN (SELECT * FROM DISHA_L2_CURATED.BASE_MODEL_DATA.CORP_ADF WHERE REPORT_DATE=LAST_DAY(:START_DATE)) CORP_ADF
		ON TRIM(TAL.LOAN_NO)=TRIM(CORP_ADF.LOAN_NO)
	LEFT JOIN (SELECT * FROM DISHA_L2_CURATED.BOLTON.BREAKUP_LOANS WHERE EFFECTIVE_DATE=LAST_DAY(:START_DATE)) BOLT 
		ON TRIM(TAL.LOAN_NO)=TRIM(BOLT.NEW_LOAN_NO) 
	LEFT JOIN (SELECT * FROM DISHA_L2_CURATED.MANUAL_INGESTION_TABLES.REGULATORY_RURAL_URBAN_TAGGING  WHERE TO_DATE(REPORT_DATE,''DD-MM-YYYY'')=LAST_DAY(:START_DATE)) RUT
		ON TRIM(TAL.LOAN_NO)=TRIM(RUT.LOAN_NO)
	LEFT JOIN(
		SELECT LOAN_NO, 
			   CASE WHEN ABS(SUM(NET_D))<1e-10 THEN 0 else SUM(NET_D) end 
			   AS INTEREST_ACCRUED_BUT_NOT_DUE FROM
		(SELECT 
					
					TRIM(cod_acct_no) AS LOAN_NO,
					TRIM(cod_gl_acct) AS GL_ACCT_CODE,
					COALESCE(
					SUM(CASE WHEN UPPER(TRIM(cod_drcr)) = ''D'' THEN amt_txn_lcy ELSE 0 END) -
					SUM(CASE WHEN UPPER(TRIM(cod_drcr)) = ''C'' THEN amt_txn_lcy ELSE 0 END),
					0
				) AS NET_D 
				FROM REG_UAT_BACKUP.FLEX_LMS.XF_STCAP_GL_TXNS_MMDD
				WHERE 
					ACTIVATION_FLAG=1 AND 
					
				cod_gl_acct IN (11050201, 11050202, 11050209, 11050210)
					AND dat_txn_posting BETWEEN ''2024-08-01'' AND :MONTH_END_DATE
				GROUP BY 1,2) 
				GROUP BY LOAN_NO
			)GL_TX_DTL
			ON TRIM(GL_TX_DTL.LOAN_NO)=TRIM(TAL.LOAN_NO)
	LEFT JOIN  (select * from DISHA_L2_CURATED.HISTORICAL_LOAD.BOOKING_REPORT where DATE(extracted_date)=DATEADD(DAY,1,:MONTH_END_DATE)) BooK_RT
	ON TRIM(BOOK_RT.NEW_LOAN_ACCOUNT_NUMBER)=TRIM(TAL.LOAN_NO)
	LEFT JOIN (SELECT  EXTRACTED_DATE,TOTAL_POS,OVERDUE_INTEREST,OVERDUE_PRIN,TOTAL_DUE,PRE_EMI,LOAN_NO FROM DISHA_L2_CURATED.HISTORICAL_LOAD.COLL_DUELIST
					WHERE EXTRACTED_DATE=DATEADD(DAY,1,:MONTH_END_DATE))DULT
		ON TRIM(DULT.LOAN_NO)=TRIM(TAL.LOAN_NO)
	)PF1)PF2)PF3;

SELECT COUNT(*) INTO :DUPLICATE_COUNT
  FROM (
    SELECT LOAN_NUMBER_NEW, COUNT(*) AS RECORD_COUNT
    FROM DISHA_MART_ANALYTICS.REGULATORY_MART.OUTSTANDING_MART_PREFINAL
    GROUP BY LOAN_NUMBER_NEW
    HAVING COUNT(*) > 1
  );


    SELECT COUNT(*) INTO :TOTAL_ROWS_IN_PREFINAL
    FROM DISHA_MART_ANALYTICS.REGULATORY_MART.OUTSTANDING_MART_PREFINAL;

----IF TOTAL ROW COUNT 0 , Return Detailed Error
	IF (TOTAL_ROWS_IN_PREFINAL = 0) THEN
		ERROR_MESSAGE := ''PREFINAL QUERY EXECUTED SUCCESSFULLY BUT RETURNED 0 RECORDS. PLEASE VERIFY SOURCE DATA AND JOIN CONDITIONS.'';
		
		INSERT INTO DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON
		(PROCEDURE_NAME, TABLE_NAME, EXECUTION_DATE, PREFINAL_CNT, INSERTED_CNT, UPDATED_CNT, UNCHANGED_CNT,STATUS,START_TIME,END_TIME,REMARKS)
		SELECT :PROC_NAME,:TBL_NAME,DATE(:CURR_TIME),:TOTAL_ROWS_IN_PREFINAL,:ROWS_INSERTED,:ROWS_UPDATED,:ROWS_UNCHANGED,''FAIL'',:CURR_TIME,CURRENT_TIMESTAMP,:ERROR_MESSAGE;	
		
		RETURN ''PREFINAL_FAILED: '' || ERROR_MESSAGE;
	END IF;
	
   -- If duplicates exist, return detailed error
    IF (DUPLICATE_COUNT > 0) THEN
          SELECT CONCAT(
            ''===== DATA LOADING FAILED =====
'',
            ''Total Rows in Prefinal: '', :TOTAL_ROWS_IN_PREFINAL, ''
'',
            ''Duplicate Rows Found: '', :DUPLICATE_COUNT, ''
'',
            ''ERROR: Unable to load data due to duplicate entries for LOAN_NUMBER_NEW.'',''
''
        ) INTO :FINAL_OUTPUT;
						--INSERT AUDIT INFO INTO TABLE
		/*DELETE FROM DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON 
		WHERE  PROCEDURE_NAME=:PROC_NAME
		AND	   EXECUTION_DATE=DATE(:CURR_TIME);*/
		
		INSERT INTO DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON
		(PROCEDURE_NAME, TABLE_NAME, EXECUTION_DATE, PREFINAL_CNT, INSERTED_CNT, UPDATED_CNT, UNCHANGED_CNT,STATUS,START_TIME,END_TIME,REMARKS)
		SELECT :PROC_NAME,:TBL_NAME,DATE(:CURR_TIME),:TOTAL_ROWS_IN_PREFINAL,:ROWS_INSERTED,:ROWS_UPDATED,:ROWS_UNCHANGED,''FAIL'',:CURR_TIME,CURRENT_TIMESTAMP,:FINAL_OUTPUT;
		
        RETURN FINAL_OUTPUT;
   END IF;
	      -- Perform MERGE operation with tracking
	INSERT INTO DISHA_MART_ANALYTICS.REGULATORY_MART.OUTSTANDING_MART (
		LOAN_NUMBER_NEW,
		LOAN_NUMBER_OLD,
		--IGAAP_POS,
		IND_AS_EAD,
		ON_BOOK_POS,
		TOTAL_POS_AS_PER_LMS,
		ECL,
		PRODUCT,
		SCHEME,
		NHB_PRODUCT,
		FIRST_DISBURSEMENT_DATE,
		CUSTOMER_TYPE,
		ASSET_CLASSIFICATION_IGAAP,
		ASSET_CLASSIFICATION_IND_AS,
		RURAL_URBAN,
		PROPERTY_STATE,
		BRANCH_STATE,
		MONTHLY_INCOME_OF_BORROWERS_IN_LOAN,
		CASTE_CATEGORY,
		TAGGING_OF_NHB_REFINANCE_CASES,
		HL_BIFURCATION_OF__EAD,
		NHL_BIFURCATION_OF__EAD,
		SHRIRAM_PROPERTY_INSURANCE_SC_CODE_160,
		INSURANCE_PREMIUM_HDFC_LIFE_SC_CODE_254,
		CERSAI_REGISTRATION_CHARGES_SC_CODE_1167,
		RCU_CHARGES_SC_CODE_1258,
		ICICI_LIFE_INSURANCE_SC_CODE_442,
		VALUATION_CHARGES_SC_CODE_1122,
		LEGAL_CHARGES_SC_CODE_1123,
		ICICI_LOMBARD_PROPERTY_INSURANCE_SC_CODE_439,
		BHARTI_AXA_LIFE_INSURANCE_SC_CODE_443,
		CARE_HEALTH_INSURANCE_SC_CODE_446,
		ADMINISTRATIVE_FEES_SC_CODE_1441,
		STAMPING_CHARGES_SC_CODE_1120,
		SERVICE_CHARGE_PDD_SC_CODE_1153,
		PROCESSING_FEES_SC_CODE_1106,
		CHARGES_DEDUCTED_AT_DISBURSEMENT,
		LOAN_AMOUNT,
		DISBURSEMENT_AMOUNT_TILL_DATE,
		ROI_AS_ON_REPORTING_DATE,
		PARENT_LOAN_TAGGING,
		POOL_NAME,
		ASSIGNMENT_TAGGING,
		PROPERTY_VALUATION_AT_THE_TIME_OF_SANCTION,
		LTV,
		DLTV,
		COMBINED_LTV,
		CUSTOMER_NAME,
		WHETHER_PMAY_BENEFIT_PROVIDED,
		TENURE_AT_THE_TIME_OF_SANCTION,
		LISTING_OF_EMPLOYEE_LOANS,
		TOTAL_OUTSTANDING,
		REMAINING_TENURE_AT_REPORTING_DATE,
		CRE_TAGGING,
		CRE_RH_TAGGING,
		SMA_CLASSIFICATION,
		RWA_CLASSIFICATION,
		RESTRUCTURE_TAGGING,
		OVERDUE_POS,
		OVERDUE_INTEREST,
		DPD,
		ROI_TYPE,
		DISBURSAL_STATUS,
		UNDISBURSED_AMOUNT,
		INTEREST_ACCRUED_BUT_NOT_DUE,
		DATE_OF_NPA,
		CUST_ID,
		PAN,
		PROPERTY_TYPE,
		PROPERTY_ADDRESS,
		ADDRESS_1,
		ADDRESS_2,
		ADDRESS_3,
		ADDRESS_4,
		PLOT_NUMBER,
		FLOOR,
		LANDMARK,
		TEHSIL,
		DISTRICT,
		COUNTRY,
		PINCODE,
		PROPERTY_AREA,
		LOAN_PURPOSE,
		--STAGING,
		POOL_ID,
		MORATORIUM,
		GENDER,
		TRANSACTION_STRUCTURE,
		NEXT_RESET_DATE,
		PROPERTY_IDENTIFIER,
		HL_BIFURCATION_OF__ECL,
		NHL_BIFURCATION_OF__ECL,
		INTEREST_RECEIVABLE,
		INSURANCE_CHARGE_DEDUCTED,
		LOAN_AUTHOR_DATE,
		LOAN_NPA_TYPE,
		HL_POS,
		NHL_POS,
		CAR_OUTSTANDING,
		REPAYMENT_DURING_MONTH,
		PRINCIPAL_REPAYMENT_DURING_MONTH,
		INTEREST_REPAYMENT_DURING_MONTH,
		OUTSTATNDING_IRAC_PROVISION,
		HL_INSURANCE,
		EAD_NET_NHL,
		CAR_CLASSIFICATION,
		PROVISION_AS_PER_IRACP_NORMS,
		HL_PROVISION_AS_PER_IRACP_NORMS,
		NHL_PROVISION_AS_PER_IRACP_NORMS,
		PROVISION_STATUS,
		PROVISIONING_TO_MAINTAIN,
		PROVISION_RATE,
		PROVISION_ON_RESTUCTURE_2_CASES,
		TOTAL_FINAL_PROVISION_AS_PER_IRAC,
		DAILY_DATE,
		REPORT_DATE
		) 
		SELECT
			S.LOAN_NUMBER_NEW,
		S.LOAN_NUMBER_OLD,
		--S.IGAAP_POS,
		S.IND_AS_EAD,
		S.ON_BOOK_POS,
		S.TOTAL_POS_AS_PER_LMS,
		S.ECL,
		S.PRODUCT,
		S.SCHEME,
		S.NHB_PRODUCT,
		S.FIRST_DISBURSEMENT_DATE,
		S.CUSTOMER_TYPE,
		S.ASSET_CLASSIFICATION_IGAAP,
		S.ASSET_CLASSIFICATION_IND_AS,
		S.RURAL_URBAN,
		S.PROPERTY_STATE,
		S.BRANCH_STATE,
		S.MONTHLY_INCOME_OF_BORROWERS_IN_LOAN,
		S.CASTE_CATEGORY,
		S.TAGGING_OF_NHB_REFINANCE_CASES,
		S.HL_BIFURCATION_OF__EAD,
		S.NHL_BIFURCATION_OF__EAD,
		S.SHRIRAM_PROPERTY_INSURANCE_SC_CODE_160,
		S.INSURANCE_PREMIUM_HDFC_LIFE_SC_CODE_254,
		S.CERSAI_REGISTRATION_CHARGES_SC_CODE_1167,
		S.RCU_CHARGES_SC_CODE_1258,
		S.ICICI_LIFE_INSURANCE_SC_CODE_442,
		S.VALUATION_CHARGES_SC_CODE_1122,
		S.LEGAL_CHARGES_SC_CODE_1123,
		S.ICICI_LOMBARD_PROPERTY_INSURANCE_SC_CODE_439,
		S.BHARTI_AXA_LIFE_INSURANCE_SC_CODE_443,
		S.CARE_HEALTH_INSURANCE_SC_CODE_446,
		S.ADMINISTRATIVE_FEES_SC_CODE_1441,
		S.STAMPING_CHARGES_SC_CODE_1120,
		S.SERVICE_CHARGE_PDD_SC_CODE_1153,
		S.PROCESSING_FEES_SC_CODE_1106,
		S.CHARGES_DEDUCTED_AT_DISBURSEMENT,
		S.LOAN_AMOUNT,
		S.DISBURSEMENT_AMOUNT_TILL_DATE,
		S.ROI_AS_ON_REPORTING_DATE,
		S.PARENT_LOAN_TAGGING,
		S.POOL_NAME,
		S.ASSIGNMENT_TAGGING,
		S.PROPERTY_VALUATION_AT_THE_TIME_OF_SANCTION,
		S.LTV,
		S.DLTV,
		S.COMBINED_LTV,
		S.CUSTOMER_NAME,
		S.WHETHER_PMAY_BENEFIT_PROVIDED,
		S.TENURE_AT_THE_TIME_OF_SANCTION,
		S.LISTING_OF_EMPLOYEE_LOANS,
		S.TOTAL_OUTSTANDING,
		S.REMAINING_TENURE_AT_REPORTING_DATE,
		S.CRE_TAGGING,
		S.CRE_RH_TAGGING,
		S.SMA_CLASSIFICATION,
		S.RWA_CLASSIFICATION,
		S.RESTRUCTURE_TAGGING,
		S.OVERDUE_POS,
		S.OVERDUE_INTEREST,
		S.DPD,
		S.ROI_TYPE,
		S.DISBURSAL_STATUS,
		S.UNDISBURSED_AMOUNT,
		S.INTEREST_ACCRUED_BUT_NOT_DUE,
		S.DATE_OF_NPA,
		S.CUST_ID,
		S.PAN,
		S.PROPERTY_TYPE,
		S.PROPERTY_ADDRESS,
		S.ADDRESS_1,
		S.ADDRESS_2,
		S.ADDRESS_3,
		S.ADDRESS_4,
		S.PLOT_NUMBER,
		S.FLOOR,
		S.LANDMARK,
		S.TEHSIL,
		S.DISTRICT,
		S.COUNTRY,
		S.PINCODE,
		S.PROPERTY_AREA,
		S.LOAN_PURPOSE,
		--S.STAGING,
		S.POOL_ID,
		S.MORATORIUM,
		S.GENDER,
		S.TRANSACTION_STRUCTURE,
		S.NEXT_RESET_DATE,
		S.PROPERTY_IDENTIFIER,
		S.HL_BIFURCATION_OF__ECL,
		S.NHL_BIFURCATION_OF__ECL,
		S.INTEREST_RECEIVABLE,
		S.INSURANCE_CHARGE_DEDUCTED,
		S.LOAN_AUTHOR_DATE,
		S.LOAN_NPA_TYPE,
		S.HL_POS,
		S.NHL_POS,
		S.CAR_OUTSTANDING,
		S.REPAYMENT_DURING_MONTH,
		S.PRINCIPAL_REPAYMENT_DURING_MONTH,
		S.INTEREST_REPAYMENT_DURING_MONTH,
		S.OUTSTATNDING_IRAC_PROVISION,
		S.HL_INSURANCE,
		S.EAD_NET_NHL,
		S.CAR_CLASSIFICATION,
		S.PROVISION_AS_PER_IRACP_NORMS,
		S.HL_PROVISION_AS_PER_IRACP_NORMS,
		S.NHL_PROVISION_AS_PER_IRACP_NORMS,
		S.PROVISION_STATUS,
		S.PROVISIONING_TO_MAINTAIN,
		S.PROVISION_RATE,
		S.PROVISION_ON_RESTUCTURE_2_CASES,
		S.TOTAL_FINAL_PROVISION_AS_PER_IRAC,
		DATE(:CURR_TIME), 
		LAST_DAY(:START_DATE)
		FROM DISHA_MART_ANALYTICS.REGULATORY_MART.OUTSTANDING_MART_PREFINAL S;

        -- Count rows affected
         ROWS_INSERTED := (SELECT COUNT(*) FROM DISHA_MART_ANALYTICS.REGULATORY_MART.OUTSTANDING_MART WHERE REPORT_DATE=LAST_DAY(:START_DATE));
         ROWS_UPDATED := 0;
         ROWS_UNCHANGED := :TOTAL_ROWS_IN_PREFINAL - (:ROWS_INSERTED + :ROWS_UPDATED);
		 

	--DROP TEMP TABLE
	DROP TABLE IF EXISTS DISHA_MART_ANALYTICS.REGULATORY_MART.OUTSTANDING_MART_PREFINAL;
	
	
          SELECT CONCAT(
            ''===== DATA LOADING REPORT =====
'',
            ''Process Timestamp: '', :CURR_TIME, ''
'',
            ''Total Rows in Prefinal: '', :TOTAL_ROWS_IN_PREFINAL, ''
'',
            ''Rows Inserted: '', :ROWS_INSERTED, ''
'',
            ''Rows Updated: '', :ROWS_UPDATED, ''
'',
            ''Rows Unchanged: '', :ROWS_UNCHANGED, ''

'',
            ''

'',
            ''Status: SUCCESSFULLY LOADED DATA INTO OUTSTANDING_MART''
        ) INTO :FINAL_OUTPUT;
		
		--INSERT AUDIT INFO INTO TABLE
		/*DELETE FROM DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON 
		WHERE  PROCEDURE_NAME=:PROC_NAME
		AND	   EXECUTION_DATE=DATE(:CURR_TIME);*/
		
		INSERT INTO DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON
		(PROCEDURE_NAME, TABLE_NAME, EXECUTION_DATE, PREFINAL_CNT, INSERTED_CNT, UPDATED_CNT, UNCHANGED_CNT,STATUS,START_TIME,END_TIME,REMARKS)
		SELECT :PROC_NAME,:TBL_NAME,DATE(:CURR_TIME),:TOTAL_ROWS_IN_PREFINAL,:ROWS_INSERTED,:ROWS_UPDATED,:ROWS_UNCHANGED,''PASS'',:CURR_TIME,CURRENT_TIMESTAMP,:FINAL_OUTPUT;
		
        RETURN FINAL_OUTPUT;
		
----For Any other exception
	EXCEPTION
        WHEN OTHER THEN
            ERROR_MESSAGE := ''ERROR IN SCD TYPE2 LOAD: '' || SQLERRM || '' (ERROR CODE: '' || sqlcode || '')'';
                        
		INSERT INTO DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON
		(PROCEDURE_NAME, TABLE_NAME, EXECUTION_DATE, PREFINAL_CNT, INSERTED_CNT, UPDATED_CNT, UNCHANGED_CNT,STATUS,START_TIME,END_TIME,REMARKS)
		SELECT :PROC_NAME,:TBL_NAME,DATE(:CURR_TIME),:TOTAL_ROWS_IN_PREFINAL,:ROWS_INSERTED,:ROWS_UPDATED,:ROWS_UNCHANGED,''FAIL'',:CURR_TIME,CURRENT_TIMESTAMP,:ERROR_MESSAGE;	
		
		RETURN ''DATA LOADING FAILED, '' || ERROR_MESSAGE;

END';