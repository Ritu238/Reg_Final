CREATE OR REPLACE PROCEDURE DISHA_MART_ANALYTICS.REGULATORY_MART.LOAD_COBORROWER_DETAILS_MART_V1("START_DATE" DATE DEFAULT DATE_ADDMONTHSTODATE(-1, CURRENT_DATE()))
RETURNS VARCHAR(255)
LANGUAGE SQL
EXECUTE AS OWNER
AS '
DECLARE 
	PROC_NAME VARCHAR(500):=''DISHA_MART_ANALYTICS.REGULATORY_MART.LOAD_COBORROWER_DETAILS_MART_V1'';
	TBL_NAME VARCHAR(500):='' DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_DETAILS_MART_V1'';
    TOTAL_ROWS_IN_PREFINAL INTEGER DEFAULT 0;
    ROWS_INSERTED INTEGER DEFAULT 0;
    ROWS_UPDATED INTEGER DEFAULT 0;
    ROWS_UNCHANGED INTEGER DEFAULT 0;
    DUPLICATE_COUNT INTEGER;
    DUPLICATE_DETAILS VARCHAR(2000);
    CURR_TIME TIMESTAMP := TO_VARCHAR(CURRENT_TIMESTAMP());
    ERROR_MESSAGE VARCHAR(1000);
    FINAL_OUTPUT VARCHAR(4000);
BEGIN

    -- STEP 1: Initialize date parameters for the current month
    LET MONTH_START_DATE DATE := DATE_TRUNC(''MONTH'',:START_DATE);
    LET MONTH_END_DATE DATE := LAST_DAY(:START_DATE);
	
    -- CREATE TABLE IF IT DOESN''T EXIST
    CREATE TABLE IF NOT EXISTS DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_DETAILS_MART_V1
	(
		DAILY_DATE DATE,
		ddate DATE,
		IBANKID NUMBER,
		sbloanno VARCHAR(255),
		scin VARCHAR(255),
		scbcin VARCHAR(255),
		scbname VARCHAR(255),
		dcbdob DATE,
		scbcitizenship VARCHAR(255),
		scbpanno VARCHAR(255),
		AADHARNUMBERMASKED VARCHAR(255),
		scbaadhaar VARCHAR(255),
		sidtype VARCHAR(255),
		sidnumber VARCHAR(255),
		ncbmonthlyincome FLOAT,
		scbreligion VARCHAR(255),
		scbcast VARCHAR(255),
		scbgender VARCHAR(255),
		scboccupation VARCHAR(500));

	   -- STEP 2: CLEAN EXISTING DATA FOR GIVEN MONTH
    DELETE FROM DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_DETAILS_MART_V1
    WHERE ddate = LAST_DAY(:START_DATE);
	
	-- STEP : CLEAN UP TEMPORARY TABLES
	DROP TABLE IF EXISTS DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_LOAN_BASE;
	DROP TABLE IF EXISTS DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_LOAN_COAPP_BASE;
	DROP TABLE IF EXISTS DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_COAPP_LOAN_BASE_FINAL;
	DROP TABLE IF EXISTS DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_DETAILS_MART_V1_PREFINAL;
	


CREATE OR REPLACE TEMPORARY TABLE DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_LOAN_BASE AS
    SELECT
        DISTINCT TRIM(LD.LOAN_NO) AS LOAN_ACCOUNT_NUMBER,
        -- GET PRIMARY BORROWER DETAILS
        PRIMARY_CRF.CUST_ID_FLEX AS PRIMARY_CUST_ID
    FROM (
        SELECT * 
        FROM REG_UAT_BACKUP.BASE_MODEL_DATA.LOAN_ACCOUNT_DETAILS WHERE ACTIVATION_FLAG=1
		AND FIRST_DISBURSAL_DATE BETWEEN :MONTH_START_DATE AND :MONTH_END_DATE
        AND LOAN_CLOSURE_DATE IS NULL
    ) LD
    -- JOIN FOR PRIMARY BORROWER
    INNER JOIN (
        SELECT * 
        FROM REG_UAT_BACKUP.BASE_MODEL_DATA.CUSTOMER_DETAILS_FLEXCUBE 
        WHERE CUSTOMER_TYPE = ''I'' AND  ACTIVATION_FLAG=1
    ) CDF 
        ON TRIm(LD.CUST_ID_FLEX)= TRIM(CDF.CUST_ID_FLEX)
    -- JOIN FOR PRIMARY BORROWER RELATIONSHIP
    INNER JOIN (
    SELECT * 
        FROM REG_UAT_BACKUP.BASE_MODEL_DATA.CUSTOMER_ROLE_FLEXCUBE
        WHERE ACTIVATION_FLAG=1 AND ACCT_CUST_REL IN (''JAF'', ''SOW'') and flag_mnt_status=''A''
    ) PRIMARY_CRF 
        ON TRIM(LD.LOAN_NO) = TRIM(PRIMARY_CRF.LOAN_NO)

	UNION 

		(
		/*SELECT TRIM(SBLOANNO) AS NEW_SBLOANNO ,CAST(TRIM(LD1.CUST_ID_FLEX) AS INT)AS SCIN FROM DISHA_L2_CURATED.HISTORICAL_LOAD.COALESCE_STG_LOAN_FIN_MAR25 A
			LEFT JOIN  (SELECT * FROM REG_UAT_BACKUP.BASE_MODEL_DATA.LOAN_ACCOUNT_DETAILS WHERE ACTIVATION_FLAG=1) LD1
			ON NEW_SBLOANNO=TRIM(LD1.LOAN_NO)
			WHERE A.SACCNTCLOSEDDURMTH=''NO'' AND A.DDATE=DATEADD(DAY,-1,:MONTH_START_DATE)
		
		--UNION*/
		
		SELECT  TRIM(SBLOANNO) AS NEW_SBLOANNO ,CAST(TRIM(LD1.CUST_ID_FLEX) AS INT)AS SCIN FROM DISHA_MART_ANALYTICS.REGULATORY_MART.BRWR_LN_DTLS_MART_WI_CLSE  A 
		LEFT JOIN  (SELECT * FROM REG_UAT_BACKUP.BASE_MODEL_DATA.LOAN_ACCOUNT_DETAILS WHERE ACTIVATION_FLAG=1) LD1
		ON SBLOANNO=TRIM(LD1.LOAN_NO) WHERE A.SACCNTCLOSEDDURMTH=''NO'' AND A.DDATE=LAST_DAY(DATE_ADDMONTHSTODATE(-1, :START_DATE))
		);	
		
		
CREATE OR REPLACE TEMPORARY TABLE DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_LOAN_COAPP_BASE AS
        
		SELECT 
		LBASE.LOAN_ACCOUNT_NUMBER,
        LBASE.PRIMARY_CUST_ID,
		COAPP_CRF.CUST_ID_FLEX AS COB,
        COAPP_CRF.ACCT_CUST_REL AS COD_ACCT_CUST_REL,	
		ROW_NUMBER() OVER (
            PARTITION BY LBASE.LOAN_ACCOUNT_NUMBER
            ORDER BY COAPP_CRF.CUST_ID_FLEX
        ) AS COB_RANK
    FROM 
		DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_LOAN_BASE LBASE
    LEFT JOIN (
        SELECT * 
        FROM REG_UAT_BACKUP.BASE_MODEL_DATA.CUSTOMER_ROLE_FLEXCUBE
        WHERE ACTIVATION_FLAG=1 AND ACCT_CUST_REL = ''JAO'' AND flag_mnt_status=''A''
    ) COAPP_CRF 
        ON TRIM(LBASE.LOAN_ACCOUNT_NUMBER)= TRIM(COAPP_CRF.LOAN_NO)
		
	LEFT JOIN (
	SELECT * 
        FROM REG_UAT_BACKUP.BASE_MODEL_DATA.CUSTOMER_DETAILS_FLEXCUBE 
        WHERE CUSTOMER_TYPE = ''I'' AND  ACTIVATION_FLAG=1)CDF_COAPP_CRF
	ON TRIM(COAPP_CRF.CUST_ID_FLEX)=TRIM(CDF_COAPP_CRF.CUST_ID_FLEX)
	WHERE CDF_COAPP_CRF.CUST_ID_FLEX IS NOT NULL
    AND COAPP_CRF.CUST_ID_FLEX IS NOT NULL;
    

-- STEP 2: CREATE FINAL TABLE WITH MAXIMUM 5 CO-APPLICANTS PER LOAN
CREATE OR REPLACE TEMPORARY TABLE DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_COAPP_LOAN_BASE_FINAL AS
    SELECT 
        LOAN_ACCOUNT_NUMBER,
        PRIMARY_CUST_ID,
		COB
    FROM DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_LOAN_COAPP_BASE
    WHERE COB_RANK>=1 AND COB_RANK <= 5;  -- LIMIT TO 5 CO-APPLICANTS

    -- STEP 4: CREATE PRE-FINAL MART WITH ALL REQUIRED CALCULATIONS
	
	CREATE OR REPLACE TEMPORARY TABLE DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_DETAILS_MART_V1_PREFINAL(
		ddate DATE,
		IBANKID NUMBER,
		sbloanno VARCHAR(255),
		scin VARCHAR(255),
		scbcin VARCHAR(255),
		scbname VARCHAR(255),
		dcbdob DATE,
		scbcitizenship VARCHAR(255),
		scbpanno VARCHAR(255),
		AADHARNUMBERMASKED VARCHAR(255),
		scbaadhaar VARCHAR(255),
		sidtype VARCHAR(255),
		sidnumber VARCHAR(255),
		ncbmonthlyincome FLOAT,
		scbreligion VARCHAR(255),
		scbcast VARCHAR(255),
		scbgender VARCHAR(255),
		scboccupation VARCHAR(500)
		) AS
    SELECT 
        LAST_DAY(:START_DATE) AS ddate,
        ''1'' AS IBANKID,
		CLBF.LOAN_ACCOUNT_NUMBER AS sbloanno,
		CLBF.PRIMARY_CUST_ID AS scin,
		CLBF.COB AS scbcin,
		CDF.CUST_NAME_SHORT AS scbname,
		COALESCE(CDF.DATE_OF_BIRTH,CUST_DTL.CUST_DOB,CUST_DTL.CUST_DOB_V) AS dcbdob,
		CASE 
			WHEN UPPER(TRIM(CDF.NATIONALITY))= ''IN'' THEN ''CIT-01''
			ELSE ''N/A'' 
		END AS scbcitizenship,
		CDF.PAN_NUMBER as scbpanno,
		AADHAR_BASE.AADHR AS AADHARNUMBERMASKED,
		CASE WHEN AADHAR_BASE.WHETHER_AADHAAR_OBTAINED =''01'' THEN ''YES'' ELSE ''NO'' END AS scbaadhaar,
		CASE 
			WHEN AADHAR_BASE.WHETHER_AADHAAR_OBTAINED = ''01'' 
				THEN ''UIDT-02''
			WHEN TRIM(COALESCE(CDF.BORROWER_VOTER_ID,'''')) != '''' 
				THEN ''UIDT-01''
			WHEN COALESCE(TRIM(COALESCE(CDF.BORROWER_VOTER_ID,'''')),'''')= '''' AND (TRIM(COALESCE(CDF.BORROWER_LICENSE,'''')) != '''' OR TRIM(COALESCE(BORROWER_PASSPORT,'''')) != '''' OR TRIM(COALESCE(CKYC_NUMBER,'''')) != '''')
				THEN ''UIDT-02''
		END AS sidtype,
		NULL AS sidnumber,
		COALESCE(CR.MONTHLY_INCOME_ASSESSED,0) AS ncbmonthlyincome,
		CASE WHEN COALESCE(CUST_DTL.RELIGION,APP_DTL.RELIGION) = ''HINDU'' THEN ''RE-01''
			WHEN COALESCE(CUST_DTL.RELIGION,APP_DTL.RELIGION) = ''MUSLIM'' THEN ''RE-02''
			WHEN COALESCE(CUST_DTL.RELIGION,APP_DTL.RELIGION) = ''SIKH'' THEN ''RE-03''
			WHEN COALESCE(CUST_DTL.RELIGION,APP_DTL.RELIGION) = ''CHRISTIAN'' THEN ''RE-04''
			WHEN COALESCE(CUST_DTL.RELIGION,APP_DTL.RELIGION) = ''JAIN'' THEN ''RE-05''
			WHEN COALESCE(CUST_DTL.RELIGION,APP_DTL.RELIGION) = ''BUDDHIST'' THEN ''RE-06''
			WHEN COALESCE(CUST_DTL.RELIGION,APP_DTL.RELIGION) = ''ZOROASTRIAN'' THEN ''RE-07''
			WHEN COALESCE(CUST_DTL.RELIGION,APP_DTL.RELIGION) = ''OTHERS'' THEN ''RE-08''
		ELSE '' ''
		END AS scbreligion,
		CASE 
			WHEN COALESCE(CUST_DTL.CASTE_CATEGORY,APP_DTL.CASTE_CATEGORY) = ''GENERAL'' THEN ''CA-01''
			WHEN COALESCE(CUST_DTL.CASTE_CATEGORY,APP_DTL.CASTE_CATEGORY) = ''OBC'' THEN ''CA-03''
			WHEN COALESCE(CUST_DTL.CASTE_CATEGORY,APP_DTL.CASTE_CATEGORY) = ''SC'' THEN ''CA-04''
			WHEN COALESCE(CUST_DTL.CASTE_CATEGORY,APP_DTL.CASTE_CATEGORY) = ''ST'' THEN ''CA-05''
			WHEN COALESCE(CUST_DTL.CASTE_CATEGORY,APP_DTL.CASTE_CATEGORY) = ''EWS'' THEN ''CA-02''
		ELSE '' ''
		END AS scbcast,		
		CASE 
			WHEN UPPER(TRIM(CDF.CUST_GENDER))=''M'' THEN ''G-01''
			WHEN UPPER(TRIM(CDF.CUST_GENDER))=''F'' THEN ''G-02''
		ELSE ''G-03'' 
		END AS scbgender,
		CASE 
			WHEN UPPER(TRIM(CDF.CUST_CONSTITUITON)) IN (
				''SELF EMPLOYED PROFESSIONAL'',
				''SELF EMPLOYED BUSINESSPERSON'',
				''LIMITED LIABILITY PARTNERSHIP''
			) THEN ''OC-02''			
			WHEN UPPER(TRIM(CDF.CUST_CONSTITUITON)) IN (
				''MULTI-NATIONAL CORPORATION'',
				''GOVERNMENT ENTITY'',
				''CASH SALARIED'',
				''PUBLIC SECTOR UNDERTAKING'',
				''BANK SALARIED - PRIVATE'',
				''BANK SALARIED - GOVERNMENT/PSU''
			) THEN ''OC-01''			
			WHEN UPPER(TRIM(CDF.CUST_CONSTITUITON)) IN (
				''SOLE PROPRIETORSHIP'',
				''PARTNERSHIP FIRM'',
				''PRIVATE''
			) THEN ''OC-03''
			WHEN UPPER(TRIM(CDF.CUST_CONSTITUITON)) IN (
				''RETIRED / PENSIONER'',
				''PUBLIC PRIVATE PARTNERSHIP'', 
				''COMPANY - PRIVATE LIMITED'',
				''COMPANY - PUBLIC LIMITED'',
				''NOT WORKING'',
				''SOCIETY/ TRUST'',
				''STUDENT'',
				''HINDU UNDIVIDED FAMILY'',
				''ASSOCIATION OF PERSONS''
			) THEN ''OC-04''
			WHEN UPPER(TRIM(CDF.CUST_CONSTITUITON)) = ''HOMEMAKER''  THEN ''OC-05''
			ELSE NULL
		END AS scboccupation
		
    FROM DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_COAPP_LOAN_BASE_FINAL CLBF
	LEFT JOIN (
		SELECT * FROM REG_UAT_BACKUP.BASE_MODEL_DATA.CUSTOMER_DETAILS_FLEXCUBE WHERE ACTIVATION_FLAG=1
		) CDF
	ON TRIM(CLBF.COB)=TRIM(CDF.CUST_ID_FLEX)
	LEFT JOIN (
			SELECT CAST(SUBSTR(SF_CUSTOMER_ID, 4, 8) AS INT) AS CUSTOMER_ID,
			COALESCE(SUM(INCOME1),SUM(INCOME2)) AS MONTHLY_INCOME_ASSESSED FROM REG_UAT_BACKUP.BASE_MODEL_DATA.LOAN_APPLICATION_DETAILS_TRANS 
			WHERE ACTIVATION_FLAG=1  AND COALESCE(INCOME1,INCOME2) IS NOT NULL 
			GROUP BY CAST(SUBSTR(SF_CUSTOMER_ID, 4, 8) AS INT)
			)CR
	ON TRIM(CLBF.COB)=TRIM(CR.CUSTOMER_ID) 
	LEFT JOIN(
		SELECT 
			CAST(SUBSTRING(A.SF_CUSTOMER_ID, 4, 8) AS INT) AS CUSTOMER_ID,
			A.AADHARNUMBERMASKED AS AADHR,
			CASE
				WHEN COALESCE(A.AADHARNUMBERMASKED,'''')<>'''' THEN ''01''
				ELSE ''02''
			END AS WHETHER_AADHAAR_OBTAINED
		FROM (SELECT * FROM REG_UAT_BACKUP.BASE_MODEL_DATA.APPLICANT_DETAIL WHERE ACTIVATION_FLAG=1) A
		QUALIFY ROW_NUMBER() OVER (PARTITION BY SUBSTR(A.SF_CUSTOMER_ID, 4, 8) ORDER BY A.AADHARNUMBERMASKED DESC) = 1
	) AADHAR_BASE
	ON TRIM(AADHAR_BASE.CUSTOMER_ID)=TRIM(CLBF.COB)
	LEFT JOIN
	(SELECT CAST(SUBSTRING(SF_CUSTOMER_ID, 4, 8) AS INT) AS CUSTOMER_ID,
					UPPER(TRIM(RELIGION)) AS RELIGION,
					UPPER(TRIM(CASTE_CATEGORY)) AS CASTE_CATEGORY 
			FROM REG_UAT_BACKUP.BASE_MODEL_DATA.APPLICANT_DETAIL WHERE ACTIVATION_FLAG=1 AND (RELIGION is not null or CASTE_CATEGORY is not null)
			QUALIFY ROW_NUMBER() OVER (PARTITION BY SUBSTR(SF_CUSTOMER_ID, 4, 8) ORDER BY RELIGION DESC) = 1
			)APP_DTL		
	ON TRIM(APP_DTL.CUSTOMER_ID)=TRIM(CLBF.COB)
	LEFT JOIN(
			SELECT 
			CAST(SUBSTRING(CUSTOMER_ID, 4, 8) AS INT) AS CUSTOMER_ID,
			UPPER(TRIM(CUST_CASTE_CATEGORY)) AS CASTE_CATEGORY,
			UPPER(TRIM(CUST_RELIGION)) AS RELIGION,
			CUST_DOB,CUST_DOB_V
			from REG_UAT_BACKUP.BASE_MODEL_DATA.CUSTOMER_DETAILS WHERE ACTIVATION_FLAG=1) CUST_DTL
	ON TRIM(CUST_DTL.CUSTOMER_ID)=TRIM(CLBF.COB)
	;
	
	-- Count total rows in prefinal table
    SELECT COUNT(*) INTO :TOTAL_ROWS_IN_PREFINAL
    FROM DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_DETAILS_MART_V1_PREFINAL;

----IF TOTAL ROW COUNT 0 , Return Detailed Error
	IF (TOTAL_ROWS_IN_PREFINAL = 0) THEN
		ERROR_MESSAGE := ''PREFINAL QUERY EXECUTED SUCCESSFULLY BUT RETURNED 0 RECORDS. PLEASE VERIFY SOURCE DATA AND JOIN CONDITIONS.'';
		
		INSERT INTO DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON
		(PROCEDURE_NAME, TABLE_NAME, EXECUTION_DATE, PREFINAL_CNT, INSERTED_CNT, UPDATED_CNT, UNCHANGED_CNT,STATUS,START_TIME,END_TIME,REMARKS)
		SELECT :PROC_NAME,:TBL_NAME,DATE(:CURR_TIME),:TOTAL_ROWS_IN_PREFINAL,:ROWS_INSERTED,:ROWS_UPDATED,:ROWS_UNCHANGED,''FAIL'',:CURR_TIME,CURRENT_TIMESTAMP,:ERROR_MESSAGE;	
		
		RETURN ''PREFINAL_FAILED: '' || ERROR_MESSAGE;
	END IF;

    -- Check for duplicates with details
    WITH DUPLICATE_CHECK AS (
        SELECT 
            sbloanno,scin,scbcin,
			COUNT(*) AS RECORD_COUNT
        FROM DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_DETAILS_MART_V1_PREFINAL
        GROUP BY sbloanno,scin,scbcin
        HAVING COUNT(*) > 1
    )
    SELECT COUNT(*) INTO :DUPLICATE_COUNT
    FROM DUPLICATE_CHECK;
	
		
	   -- If duplicates exist, return detailed error
    IF (DUPLICATE_COUNT > 0) THEN
          SELECT CONCAT(
            ''===== DATA LOADING FAILED =====
'',
            ''Total Rows in Prefinal: '', :TOTAL_ROWS_IN_PREFINAL, ''
'',
            ''Duplicate Rows Found: '', :DUPLICATE_COUNT, ''
'',
            ''ERROR: Unable to load data due to duplicate entries for sbloanno,scbcin combination.'',''
''
        ) INTO :FINAL_OUTPUT;
		--INSERT AUDIT INFO INTO TABLE
		/*DELETE FROM DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON 
		WHERE  PROCEDURE_NAME=:PROC_NAME
		AND	   EXECUTION_DATE=DATE(:CURR_TIME);*/
		
	INSERT INTO DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON
	(PROCEDURE_NAME, TABLE_NAME, EXECUTION_DATE, PREFINAL_CNT, INSERTED_CNT, UPDATED_CNT, UNCHANGED_CNT,STATUS,START_TIME,END_TIME,REMARKS)
	SELECT :PROC_NAME,:TBL_NAME,DATE(:CURR_TIME),:TOTAL_ROWS_IN_PREFINAL,:ROWS_INSERTED,:ROWS_UPDATED,:ROWS_UNCHANGED,''FAIL'',:CURR_TIME,CURRENT_TIMESTAMP,:FINAL_OUTPUT;	

        RETURN FINAL_OUTPUT;
    END IF;
	

	
	--STEP 5 : Insert data 
	INSERT INTO DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_DETAILS_MART_V1(
	DAILY_DATE, ddate, IBANKID, sbloanno, scin, scbcin, scbname, dcbdob, scbcitizenship, scbpanno, AADHARNUMBERMASKED, scbaadhaar, sidtype, sidnumber, ncbmonthlyincome, scbreligion, scbcast, scbgender,scboccupation)
	SELECT 
	current_date(), A.ddate, A.IBANKID, A.sbloanno, A.scin, A.scbcin, A.scbname, COALESCE(b.dcbdob,a.dcbdob) as dcbdob, COALESCE(b.scbcitizenship,A.scbcitizenship), COALESCE(b.scbpanno,a.scbpanno),a.AADHARNUMBERMASKED, 
	CASE WHEN COALESCE(b.scbaadhaar,a.scbaadhaar) IN(''01'',''YES'') THEN ''YES'' ELSE ''NO'' END
	, COALESCE(b.sidtype,a.sidtype,''UIDT-02'') as sidtype, COALESCE(b.sidnumber,a.sidnumber), COALESCE(b.ncbmonthlyincome,a.ncbmonthlyincome) as ncbmonthlyincome, COALESCE(b.scbreligion,a.scbreligion), COALESCE(b.scbcast,a.scbcast), COALESCE(b.scbgender,a.scbgender),COALESCE(b.scboccupation,a.scboccupation)
	FROM DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_DETAILS_MART_V1_PREFINAL A
	LEFT JOIN (SELECT * FROM DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_DETAILS_MART_V1 where DDATE=DATEADD(DAY,-1,:MONTH_START_DATE) QUALIFY ROW_NUMBER() OVER(PARTITION BY SCBCIN ORDER BY IBANKID)=1) B
	ON TRIM(A.scbcin)=TRIM(B.scbcin) ;
		
		        -- Count rows affected
         ROWS_INSERTED := (SELECT COUNT(*) FROM DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_DETAILS_MART_V1 WHERE ddate=LAST_DAY(:START_DATE));
         ROWS_UPDATED := 0;
         ROWS_UNCHANGED := :TOTAL_ROWS_IN_PREFINAL - (:ROWS_INSERTED + :ROWS_UPDATED);
		 
		 
		 	        -- Prepare detailed output
          SELECT CONCAT(
            ''===== DATA LOADING REPORT =====
'',
            ''Process Timestamp: '', :CURR_TIME, ''
'',
            ''Total Rows in Prefinal: '', :TOTAL_ROWS_IN_PREFINAL, ''
'',
            ''Rows Inserted: '', :ROWS_INSERTED, ''
'',
            ''Rows Updated: '', :ROWS_UPDATED, ''
'',
            ''Rows Unchanged: '', :ROWS_UNCHANGED, ''

'',
            ''

'',
            ''Status: SUCCESSFULLY LOADED DATA INTO COBORROWER_DETAILS_MART_V1''
        ) INTO :FINAL_OUTPUT;
		
		--INSERT AUDIT INFO INTO TABLE
		/*DELETE FROM DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON 
		WHERE  PROCEDURE_NAME=:PROC_NAME
		AND	   EXECUTION_DATE=DATE(:CURR_TIME);*/
		
		INSERT INTO DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON
		(PROCEDURE_NAME, TABLE_NAME, EXECUTION_DATE, PREFINAL_CNT, INSERTED_CNT, UPDATED_CNT, UNCHANGED_CNT,STATUS,START_TIME,END_TIME,REMARKS)
		SELECT :PROC_NAME,:TBL_NAME,DATE(:CURR_TIME),:TOTAL_ROWS_IN_PREFINAL,:ROWS_INSERTED,:ROWS_UPDATED,:ROWS_UNCHANGED,''PASS'',:CURR_TIME,CURRENT_TIMESTAMP,:FINAL_OUTPUT;
	
	 RETURN FINAL_OUTPUT;
	

-- STEP : CLEAN UP TEMPORARY TABLES
	-- DROP TABLE IF EXISTS DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_LOAN_BASE;
	-- DROP TABLE IF EXISTS DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_LOAN_COAPP_BASE;
	-- DROP TABLE IF EXISTS DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_COAPP_LOAN_BASE_FINAL;
	-- DROP TABLE IF EXISTS DISHA_MART_ANALYTICS.REGULATORY_MART.COBORROWER_DETAILS_MART_V1_PREFINAL;
	
----For Any other exception
	EXCEPTION
        WHEN OTHER THEN
            ERROR_MESSAGE := ''ERROR IN SCD TYPE2 LOAD: '' || SQLERRM || '' (ERROR CODE: '' || sqlcode || '')'';
                        
		INSERT INTO DISHA_MART_ANALYTICS.AUDIT_INFO.DAILY_COUNT_RECON
		(PROCEDURE_NAME, TABLE_NAME, EXECUTION_DATE, PREFINAL_CNT, INSERTED_CNT, UPDATED_CNT, UNCHANGED_CNT,STATUS,START_TIME,END_TIME,REMARKS)
		SELECT :PROC_NAME,:TBL_NAME,DATE(:CURR_TIME),:TOTAL_ROWS_IN_PREFINAL,:ROWS_INSERTED,:ROWS_UPDATED,:ROWS_UNCHANGED,''FAIL'',:CURR_TIME,CURRENT_TIMESTAMP,:ERROR_MESSAGE;	
		
		RETURN ''DATA LOADING FAILED, '' || ERROR_MESSAGE;
END';